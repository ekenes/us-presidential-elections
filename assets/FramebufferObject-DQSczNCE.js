import{j8 as C,al as p,as as U,j9 as u,dR as d,dQ as T,ja as E,aw as F,jb as y,jc as R,jd as N,je as b,jf as A,ao as B}from"./index-Dbb7O7mW.js";import{o as M}from"./BufferObject-BVvxrpYg.js";class ${constructor(t,e=0,r=e,i=!1,n=1){this.internalFormat=t,this.width=e,this.height=r,this.multisampled=i,this.samples=n}}function z(s){return s.width<=0||s.height<=0||s.internalFormat==null?0:s.width*s.height*C(s.internalFormat)}const P=!!U("esri-tests-disable-gpu-memory-measurements");class w{constructor(t,e){this._context=t,this._descriptor=e,this.type=2,this._context.instanceCounter.increment(p.Renderbuffer,this);const r=this._context.gl;this.glName=r.createRenderbuffer(),this._context.bindRenderbuffer(this);const{width:i,height:n,internalFormat:h,multisampled:a}=e;a?r.renderbufferStorageMultisample(r.RENDERBUFFER,this.samples,h,i,n):r.renderbufferStorage(r.RENDERBUFFER,h,i,n),this._context.bindRenderbuffer(null)}get descriptor(){return this._descriptor}get samples(){const t=this._descriptor.samples,e=this._context.parameters.maxSamples;return t?Math.min(t,e):e}get usedMemory(){return P?0:z(this._descriptor)}resize(t,e){const r=this._descriptor;if(r.width===t&&r.height===e)return;r.width=t,r.height=e;const i=this._context.gl;this._context.bindRenderbuffer(this),r.multisampled?i.renderbufferStorageMultisample(i.RENDERBUFFER,this.samples,r.internalFormat,r.width,r.height):i.renderbufferStorage(i.RENDERBUFFER,r.internalFormat,r.width,r.height),this._context.bindRenderbuffer(null)}dispose(){this._context&&(this._context.gl.deleteRenderbuffer(this.glName),this._context.instanceCounter.decrement(p.Renderbuffer,this),this._context=null)}}const v=()=>B.getLogger("esri.views.webgl.FramebufferObject");var l;let G=(l=class{constructor(t,e,r){if(this._context=t,this._glName=null,this._colorAttachments=new Map,this._depthStencilBuffer=null,this._depthStencilTexture=null,this._initialized=!1,t.instanceCounter.increment(p.FramebufferObject,this),e!=null){const i=I(t,e);i!=null&&(this._colorAttachments.set(u,i),f(i)?this._validateTextureDescriptor(i.descriptor):this._validateRenderbufferDescriptor(i.descriptor)),this._validateColorAttachmentPoint(u)}if(r!=null)if(L(r))this._depthStencilTexture=f(r)?r:new d(t,r),this._validateTextureDescriptor(this._depthStencilTexture.descriptor);else{const i=S(r)?r:new w(t,r);this._depthStencilBuffer=i,this._validateRenderbufferDescriptor(i.descriptor)}}dispose(){var n,h;const{_colorAttachments:t,_glName:e}=this;if(t.size===0&&!this._depthStencilBuffer&&!this._depthStencilTexture&&!e)return;const{_context:r}=this,i=r.getBoundFramebufferObject();t.forEach((a,c)=>{var o;return(o=this.detachColorTexture(c))==null?void 0:o.dispose()}),(n=this.detachDepthStencilBuffer())==null||n.dispose(),(h=this.detachDepthStencilTexture())==null||h.dispose(),r.gl.deleteFramebuffer(e),this._glName=null,r.bindFramebuffer(i===this?null:i),r.instanceCounter.decrement(p.FramebufferObject,this)}get glName(){return this._glName}get colorTexture(){const t=this._colorAttachments.get(u);return f(t)?t:null}get depthStencil(){return this._depthStencilTexture||this._depthStencilBuffer}get depthStencilTexture(){return this._depthStencilTexture}get width(){var e;const t=this._colorAttachments.get(u)??this._depthStencilTexture??this._depthStencilBuffer;return((e=t==null?void 0:t.descriptor)==null?void 0:e.width)??0}get height(){var e;const t=this._colorAttachments.get(u)??this._depthStencilTexture??this._depthStencilBuffer;return((e=t==null?void 0:t.descriptor)==null?void 0:e.height)??0}get usedMemory(){var t;return[...this._colorAttachments].reduce((e,[r,i])=>e+i.usedMemory,((t=this.depthStencil)==null?void 0:t.usedMemory)??0)}getColorTexture(t){const e=this._colorAttachments.get(t);return e&&f(e)?e:null}get colorAttachments(){return[...this._colorAttachments.keys()]}attachColorTexture(t,e=u){var i;if(!t)return;this._validateColorAttachmentPoint(e);const{descriptor:r}=t;this._validateTextureDescriptor(r),(i=this.detachColorTexture(e))==null||i.dispose(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(t.glName,e)),this._colorAttachments.set(e,t)}detachColorTexture(t=u){const e=this._colorAttachments.get(t);if(!e)return;const r=f(e);return this._initialized&&this._context.temporaryBindFramebufferObject(this,()=>{if(r)this._framebufferTexture2D(null,t);else{const i=this._context.gl;i.framebufferRenderbuffer(i.FRAMEBUFFER,t,i.RENDERBUFFER,null)}}),this._colorAttachments.delete(t),r?e:void 0}setColorTextureTarget(t,e=u,r=0){const i=this._colorAttachments.get(e);i&&(t===35866?this._framebufferTextureLayer(i.glName,e,36160,0,r):this._framebufferTexture2D(i.glName,e,t,36160,0))}attachDepthStencil(t){if(t)switch(t.type){case 1:return this._attachDepthStencilTexture(t);case 2:return this._attachDepthStencilBuffer(t)}}_attachDepthStencilTexture(t){var n;if(t==null)return;const{descriptor:e}=t,{pixelFormat:r,dataType:i}=e;r===34041||r===6402?r!==34041||i===T.UNSIGNED_INT_24_8?r!==6402||i===T.UNSIGNED_INT||i===T.UNSIGNED_SHORT?(this._validateTextureDescriptor(e),this._disposeDepthStencilAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(t.glName,m(r))),(n=this._depthStencilTexture)==null||n.dispose(),this._depthStencilTexture=t):console.error("Depth texture must have data type of UNSIGNED_INT or UNSIGNED_SHORT!"):console.error("Depth/Stencil texture must have data type of UNSIGNED_INT_24_8!"):console.error("Depth/Stencil texture must have a pixel type of DEPTH_STENCIL!")}detachDepthStencilTexture(){const t=this._depthStencilTexture;return t&&this._initialized&&this._context.temporaryBindFramebufferObject(this,()=>{this._framebufferTexture2D(null,m(t.descriptor.pixelFormat))}),this._depthStencilTexture=null,t}_attachDepthStencilBuffer(t){if(t==null)return;const e=t.descriptor;if(this._validateRenderbufferDescriptor(e),this._disposeDepthStencilAttachments(),this._initialized){this._context.bindFramebuffer(this);const{gl:r}=this._context,i=this._getGLAttachmentPoint(e);r.framebufferRenderbuffer(36160,i,r.RENDERBUFFER,t.glName)}this._depthStencilBuffer=t}detachDepthStencilBuffer(){const t=this._depthStencilBuffer;if(t&&this._initialized){const{_context:e}=this,r=e.getBoundFramebufferObject();e.bindFramebuffer(this);const{gl:i}=e,n=this._getGLAttachmentPoint(t.descriptor);i.framebufferRenderbuffer(36160,n,i.RENDERBUFFER,null),e.bindFramebuffer(r)}return this._depthStencilBuffer=null,t}invalidateAttachments(t){const{_context:e}=this;e.temporaryBindFramebufferObject(this,()=>e.gl.invalidateFramebuffer(36160,t),!0)}copyToTexture(t,e,r,i,n,h,a){(t<0||e<0||n<0||h<0)&&console.error("Offsets cannot be negative!"),(r<=0||i<=0)&&console.error("Copy width and height must be greater than zero!");const c=a.descriptor;a.descriptor.target!==3553&&console.error("Texture target must be TEXTURE_2D!"),((c==null?void 0:c.width)==null||(c==null?void 0:c.height)==null||t+r>this.width||e+i>this.height||n+r>c.width||h+i>c.height)&&console.error("Bad dimensions, the current input values will attempt to read or copy out of bounds!");const o=this._context,g=o.bindTexture(a,d.TEXTURE_UNIT_FOR_UPDATES);o.setActiveTexture(d.TEXTURE_UNIT_FOR_UPDATES),o.bindFramebuffer(this),o.gl.copyTexSubImage2D(3553,0,n,h,t,e,r,i),o.bindTexture(g,d.TEXTURE_UNIT_FOR_UPDATES)}readPixels(t,e,r,i,n,h,a){(r<=0||i<=0)&&console.error("Copy width and height must be greater than zero!"),a||console.error("Target memory is not initialized!"),this._context.bindFramebuffer(this),this._context.gl.readPixels(t,e,r,i,n,h,a)}async readPixelsAsync(t,e,r,i,n,h,a){const{gl:c}=this._context,o=M.createPixelPack(this._context,35041,a.byteLength);this._context.bindBuffer(o);const g=this._context.getBoundFramebufferObject();this._context.bindFramebuffer(this),c.readPixels(t,e,r,i,n,h,0),this._context.unbindBuffer(35051),this._context.bindFramebuffer(g),await o.getSubDataAsync(a),o.dispose()}resize(t,e){var i,n;if(this.width===t&&this.height===e)return;const r={width:t,height:e};if(_(r,this._context.parameters.maxTextureSize),this._colorAttachments.forEach(h=>h.resize(r.width,r.height)),(i=this._depthStencilTexture)==null||i.resize(r.width,r.height),this._initialized&&(_(r,this._context.parameters.maxRenderbufferSize),(n=this._depthStencilBuffer)==null||n.resize(r.width,r.height),E())){const{gl:h}=this._context;h.checkFramebufferStatus(36160)!==h.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!")}}initializeAndBind(t=36160){const{gl:e}=this._context;if(this._initialized)return void e.bindFramebuffer(t,this.glName);this._glName&&e.deleteFramebuffer(this._glName);const r=e.createFramebuffer();if(e.bindFramebuffer(t,r),this._colorAttachments.forEach((i,n)=>{if(f(i)){const h=D(i);h===35866?this._framebufferTextureLayer(i.glName,n,t,0,0):this._framebufferTexture2D(i.glName,n,h,t)}else if(S(i)){const h=this._context.gl;h.framebufferRenderbuffer(t,n,h.RENDERBUFFER,i.glName)}}),this._depthStencilBuffer){const i=this._getGLAttachmentPoint(this._depthStencilBuffer.descriptor);e.framebufferRenderbuffer(t,i,e.RENDERBUFFER,this._depthStencilBuffer.glName)}else if(this._depthStencilTexture){const i=m(this._depthStencilTexture.descriptor.pixelFormat);this._framebufferTexture2D(this._depthStencilTexture.glName,i,D(this._depthStencilTexture),t)}E()&&e.checkFramebufferStatus(t)!==e.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!"),this._glName=r,this._initialized=!0}_framebufferTexture2D(t,e=u,r=3553,i=36160,n=0){this._context.gl.framebufferTexture2D(i,e,r,t,n)}_framebufferTextureLayer(t,e=u,r=36160,i=0,n=0){this._context.gl.framebufferTextureLayer(r,e,t,i,n)}_disposeDepthStencilAttachments(){const t=this._context.gl;if(this._depthStencilBuffer){if(this._initialized){this._context.bindFramebuffer(this);const e=this._getGLAttachmentPoint(this._depthStencilBuffer.descriptor);t.framebufferRenderbuffer(36160,e,t.RENDERBUFFER,null)}this._depthStencilBuffer=F(this._depthStencilBuffer)}this._depthStencilTexture&&(this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,m(this._depthStencilTexture.descriptor.pixelFormat))),this._depthStencilTexture=F(this._depthStencilTexture))}_validateTextureDescriptor(t){t.target!==3553&&t.target!==34067&&t.target!==35866&&console.error("Texture type must be TEXTURE_2D, TEXTURE_2D_ARRAY or TEXTURE_CUBE_MAP!"),_(t,this._context.parameters.maxTextureSize),this._validateBufferDimensions(t)}_validateRenderbufferDescriptor(t){_(t,this._context.parameters.maxRenderbufferSize),this._validateBufferDimensions(t)}_validateBufferDimensions(t){t.width<=0&&(t.width=this.width),t.height<=0&&(t.height=this.height),this.width>0&&this.height>0&&(this.width===t.width&&this.height===t.height||console.error("Attachment size must match framebuffer size!"))}_getGLAttachmentPoint(t){switch(t.internalFormat){case b.DEPTH_COMPONENT16:case b.DEPTH_COMPONENT24:case b.DEPTH_COMPONENT32F:return A;case R.DEPTH24_STENCIL8:case R.DEPTH32F_STENCIL8:return N;case 36168:return y;default:return u}}_validateColorAttachmentPoint(t){if(l._MAX_COLOR_ATTACHMENTS===-1){const{gl:r}=this._context;l._MAX_COLOR_ATTACHMENTS=r.getParameter(r.MAX_COLOR_ATTACHMENTS)}const e=t-u;e+1>l._MAX_COLOR_ATTACHMENTS&&B.getLogger("esri.views.webgl.FrameBufferObject").error("esri.FrameBufferObject",`illegal attachment point for color attachment: ${e+1}. Implementation supports up to ${l._MAX_COLOR_ATTACHMENTS} color attachments`)}},l._MAX_COLOR_ATTACHMENTS=-1,l);function f(s){return x(s)===1}function S(s){return x(s)===2}function L(s){return f(s)||O(s)}function O(s){return x(s)===0}function j(s){return x(s)===3||s!=null&&"samples"in s}function x(s){return s!=null&&"type"in s?s.type:null}function I(s,t){return f(t)||S(t)?t:O(t)?new d(s,t):j(t)?new w(s,t):null}function _(s,t){const e=Math.max(s.width,s.height);if(e>t){v().warnOnce(`Resizing FBO attachment size ${s.width}x${s.height} to device limit ${t}`);const r=t/e;return s.width=Math.round(s.width*r),s.height=Math.round(s.height*r),!1}return!0}function D(s){return s.descriptor.target===34067?34069:s.descriptor.target===35866?35866:3553}function m(s){return s===6402?A:N}export{$ as i,G as m,w as s};
//# sourceMappingURL=FramebufferObject-DQSczNCE.js.map
