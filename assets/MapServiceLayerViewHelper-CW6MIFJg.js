const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Dbb7O7mW.js","assets/index-Cx5TkOmR.css"])))=>i.map(i=>d[i]);
import{gP as K,cu as L,bP as Q,f9 as X,gd as Y,gc as ee,nO as te,nP as R,h6 as B,g as z,A as re,x as n,y as u,cf as se,d3 as ie,C as J,B as D,f as oe,bZ as ae,z as A,ce as q,lD as ne,ai as le,D as ue,cv as pe,G as ye,F as ce,H as he,ef as de,bU as fe,dz as me,s as U,f_ as T,_ as ge,bx as be,eM as we,dH as ve,as as xe,gN as $e,ab as M,nQ as Se,ej as _e,dd as Fe}from"./index-Dbb7O7mW.js";import{o as H}from"./drapedUtils-S4-JqsaV.js";import{p as Pe,n as Oe}from"./popupUtils-vV4-4oK8.js";function ze(a){if(!a)return[];let e=K(a)?[a]:L.isCollection(a)?a.toArray():Array.isArray(a)?a:[];return e=e==null?void 0:e.filter(Q),((e==null?void 0:e.length)??0)===0?[]:e}function Ge(a,e){const{dpi:r,gdbVersion:t,geometry:s,geometryPrecision:i,height:f,historicMoment:o,layerOption:y,mapExtent:c,maxAllowableOffset:l,returnFieldName:h,returnGeometry:p,returnUnformattedValues:b,returnZ:S,spatialReference:_,timeExtent:m,tolerance:P,width:v}=a.toJSON(),{dynamicLayers:g,layerDefs:x,layerIds:V}=Ve(a),G=(e==null?void 0:e.geometry)!=null?e.geometry:null,w={historicMoment:o,geometryPrecision:i,maxAllowableOffset:l,returnFieldName:h,returnGeometry:p,returnUnformattedValues:b,returnZ:S,tolerance:P},$=(G==null?void 0:G.toJSON())||s;w.imageDisplay=`${v},${f},${r}`,t&&(w.gdbVersion=t),$&&(delete $.spatialReference,w.geometry=JSON.stringify($),w.geometryType=X($));const E=_??($==null?void 0:$.spatialReference)??(c==null?void 0:c.spatialReference);if(E&&(w.sr=Y(E)),w.time=m?[m.start,m.end].join(","):null,c){const{xmin:j,ymin:Z,xmax:k,ymax:W}=c;w.mapExtent=`${j},${Z},${k},${W}`}return x&&(w.layerDefs=x),g&&!x&&(w.dynamicLayers=g),w.layers=y==="popup"?"visible":y,V&&!g&&(w.layers+=`:${V.join(",")}`),w}function Ve(a){var S,_;const{mapExtent:e,floors:r,width:t,sublayers:s,layerIds:i,layerOption:f,gdbVersion:o}=a,y=(_=(S=s==null?void 0:s.find(m=>m.layer!=null))==null?void 0:S.layer)==null?void 0:_.serviceSublayers,c=f==="popup",l={},h=ee({extent:e,width:t,spatialReference:e==null?void 0:e.spatialReference}),p=[],b=m=>{const P=h===0,v=m.minScale===0||h<=m.minScale,g=m.maxScale===0||h>=m.maxScale;if(m.visible&&(P||v&&g))if(m.sublayers)m.sublayers.forEach(b);else{if((i==null?void 0:i.includes(m.id))===!1||c&&(!m.popupTemplate||!m.popupEnabled))return;p.unshift(m)}};if(s==null||s.forEach(b),s&&!p.length)l.layerIds=[];else{const m=te(p,y,o),P=p.map(v=>{const g=R(r,v);return v.toExportImageJSON(g)});if(m)l.dynamicLayers=JSON.stringify(P);else{if(s){let g=p.map(({id:x})=>x);i&&(g=g.filter(x=>i.includes(x))),l.layerIds=g}else i!=null&&i.length&&(l.layerIds=i);const v=Ee(r,p);if(v!=null&&v.length){const g={};for(const x of v)x.definitionExpression&&(g[x.id]=x.definitionExpression);Object.keys(g).length&&(l.layerDefs=JSON.stringify(g))}}}return l}function Ee(a,e){const r=!!(a!=null&&a.length),t=e.filter(s=>s.definitionExpression!=null||r&&s.floorInfo!=null);return t.length?t.map(s=>{const i=R(a,s),f=B(i,s.definitionExpression);return{id:s.id,definitionExpression:f??void 0}}):null}var I;let d=I=class extends z{static from(a){return re(I,a)}constructor(a){super(a),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.historicMoment=null,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}writeHistoricMoment(a,e){e.historicMoment=a&&a.getTime()}};n([u({type:Number,json:{write:!0}})],d.prototype,"dpi",void 0),n([u()],d.prototype,"floors",void 0),n([u({type:String,json:{write:!0}})],d.prototype,"gdbVersion",void 0),n([u({types:ie,json:{read:se,write:!0}})],d.prototype,"geometry",void 0),n([u({type:Number,json:{write:!0}})],d.prototype,"geometryPrecision",void 0),n([u({type:Number,json:{write:!0}})],d.prototype,"height",void 0),n([u({type:Date})],d.prototype,"historicMoment",void 0),n([J("historicMoment")],d.prototype,"writeHistoricMoment",null),n([u({type:[Number],json:{write:!0}})],d.prototype,"layerIds",void 0),n([u({type:["top","visible","all","popup"],json:{write:!0}})],d.prototype,"layerOption",void 0),n([u({type:D,json:{write:!0}})],d.prototype,"mapExtent",void 0),n([u({type:Number,json:{write:!0}})],d.prototype,"maxAllowableOffset",void 0),n([u({type:Boolean,json:{write:!0}})],d.prototype,"returnFieldName",void 0),n([u({type:Boolean,json:{write:!0}})],d.prototype,"returnGeometry",void 0),n([u({type:Boolean,json:{write:!0}})],d.prototype,"returnM",void 0),n([u({type:Boolean,json:{write:!0}})],d.prototype,"returnUnformattedValues",void 0),n([u({type:Boolean,json:{write:!0}})],d.prototype,"returnZ",void 0),n([u({type:oe,json:{write:!0}})],d.prototype,"spatialReference",void 0),n([u({type:L})],d.prototype,"sublayers",void 0),n([u({type:ae,json:{write:!0}})],d.prototype,"timeExtent",void 0),n([u({type:Number,json:{write:!0}})],d.prototype,"tolerance",void 0),n([u({type:Number,json:{write:!0}})],d.prototype,"width",void 0),d=I=n([A("esri.rest.support.IdentifyParameters")],d);const C=d;let F=class extends z{constructor(a){super(a),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(a,e){return q.fromJSON({attributes:{...e.attributes},geometry:{...e.geometry}})}writeFeature(a,e){if(!a)return;const{attributes:r,geometry:t}=a;r&&(e.attributes={...r}),t!=null&&(e.geometry=t.toJSON(),e.geometryType=ne.toJSON(t.type))}};n([u({type:String,json:{write:!0}})],F.prototype,"displayFieldName",void 0),n([u({type:q})],F.prototype,"feature",void 0),n([le("feature",["attributes","geometry"])],F.prototype,"readFeature",null),n([J("feature")],F.prototype,"writeFeature",null),n([u({type:Number,json:{write:!0}})],F.prototype,"layerId",void 0),n([u({type:String,json:{write:!0}})],F.prototype,"layerName",void 0),F=n([A("esri.rest.support.IdentifyResult")],F);const je=F;async function Ne(a,e,r){const t=(e=Re(e)).geometry?[e.geometry]:[],s=ue(a);return s.path+="/identify",pe(t).then(i=>{const f=Ge(e,{geometry:i==null?void 0:i[0]}),o=ye({...s.query,f:"json",...f}),y=ce(o,r);return he(s.path,y).then(Ie).then(c=>Ae(c,e.sublayers))})}function Ie(a){const e=a.data;return e.results=e.results||[],e.exceededTransferLimit=!!e.exceededTransferLimit,e.results=e.results.map(r=>je.fromJSON(r)),e}function Re(a){return a=C.from(a)}function Ae(a,e){if(!(e!=null&&e.length))return a;const r=new Map;function t(s){r.set(s.id,s),s.sublayers&&s.sublayers.forEach(t)}e.forEach(t);for(const s of a.results)s.feature.sourceLayer=r.get(s.layerId);return a}let N=null;function Je(a,e){return e.type==="tile"||e.type==="map-image"}let O=class extends de{constructor(e){super(e),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=fe(async r=>{this.destroyed||await this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(r).catch(()=>{}))})}initialize(){const e=r=>{var t;for(const s of r){const{sourceLayer:i}=s;i!=null&&"geometryType"in i&&i.geometryType==="point"&&s.visible&&(s.visible=!1,(t=this.highlightGraphicUpdated)==null||t.call(this,{graphic:s,property:"visible",oldValue:!0,newValue:!1}))}this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(r).catch(()=>{})),_e(this.updateHighlightedFeatures(this._highlightGeometriesResolution))};this.addHandles([me(()=>this.highlightGraphics,"change",r=>e(r.added),{onListenerAdd:r=>e(r)})])}async fetchPopupFeaturesAtLocation(e,r){var o,y;const{layerView:{layer:t,view:{scale:s}}}=this;if(!e)throw new U("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:t});const i=Ue(t.sublayers,s,r);if(!i.length)return[];const f=await Me(t,i);if(!((((y=(o=t.capabilities)==null?void 0:o.operations)==null?void 0:y.supportsIdentify)??!0)&&t.version>=10.5)&&!f)throw new U("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:t});return f?this._fetchPopupFeaturesUsingQueries(e,i,r):this._fetchPopupFeaturesUsingIdentify(e,i,r)}clearHighlights(){var e;(e=this.highlightGraphics)==null||e.removeAll()}async _updateHighlightedFeaturesSymbols(e){for(const r of e)this._updateSymbology(r)}_updateSymbology(e){var r;if(((r=e.geometry)==null?void 0:r.type)==="point")return this._updatePointSymbology(e)}_setGraphicSymbol(e,r){var s;if(!r)return;const t=e.symbol;e.symbol=r,(s=this.highlightGraphicUpdated)==null||s.call(this,{graphic:e,property:"symbol",oldValue:t,newValue:r})}_updatePointSymbology(e){const r=e.sourceLayer&&"renderer"in e.sourceLayer&&e.sourceLayer.renderer,{highlightGraphicUpdated:t,highlightGraphics:s,layerView:{view:i}}=this,f=o=>{o.visible||(o.visible=!0,t==null||t({graphic:o,property:"visible",oldValue:!1,newValue:!0}))};r&&"getSymbolAsync"in r?r.getSymbolAsync(e).then(async o=>{var l;o||(o=new T);let y=null;const c="visualVariables"in r?(l=r.visualVariables)==null?void 0:l.find(h=>h.type==="size"):void 0;c&&(N||(N=(await ge(async()=>{const{getSize:h}=await import("./index-Dbb7O7mW.js").then(p=>p.xy);return{getSize:h}},__vite__mapDeps([0,1]))).getSize),y=N(c,e,{view:i.type,scale:i.scale,shape:o.type==="simple-marker"?o.style:null})),y||(y="width"in o&&"height"in o&&o.width!=null&&o.height!=null?Math.max(o.width,o.height):"size"in o?o.size:16),s!=null&&s.includes(e)&&(this._setGraphicSymbol(e,new T({style:"square",size:y,color:new be([255,255,255,1/255]),xoffset:"xoffset"in o?o.xoffset:0,yoffset:"yoffset"in o?o.yoffset:0})),f(e))}):f(e)}get _updateContext(){const{layerView:{layer:e},highlightGraphics:r,highlightGraphicUpdated:t}=this;return t&&(r!=null&&r.length)&&e.capabilities.operations.supportsQuery?{highlightGraphicUpdated:t,highlightGraphics:r}:null}get highlightFeaturesActive(){return!!this._updateContext}async _updateHighlightedFeaturesGeometries(e){this._highlightGeometriesResolution=e;const r=this._updateContext;if(!r)return;const t=this._getTargetResolution(e),s=new Map,{highlightGraphics:i,highlightGraphicUpdated:f}=r;for(const l of i)if(!this._featuresResolutions.has(l)||this._featuresResolutions.get(l)>t){const h=l.sourceLayer;we(s,h,()=>new Map).set(l.getObjectId(),l)}const{layerView:{view:o}}=this,y=Array.from(s,([l,h])=>{const p=l.createQuery();return p.objectIds=[...h.keys()],p.outFields=[l.objectIdField],p.returnGeometry=!0,p.maxAllowableOffset=t,p.outSpatialReference=o.spatialReference,l.queryFeatures(p)}),c=await Promise.all(y);if(!this.destroyed)for(const{features:l}of c)for(const h of l){const p=h.sourceLayer,b=s.get(p).get(h.getObjectId());if(b&&i.includes(b)){const S=b.geometry;b.geometry=h.geometry,f({graphic:b,property:"geometry",oldValue:S,newValue:b.geometry}),this._featuresResolutions.set(b,t)}}}_getTargetResolution(e){const r=e*ve(this.layerView.view.spatialReference),t=r/16;return t<=10?0:e/r*t}async _fetchPopupFeaturesUsingIdentify(e,r,t){const s=await this._createIdentifyParameters(e,r,t);if(s==null)return[];const{results:i}=await Ne(this.layerView.layer.parsedUrl,s,t);return i.map(f=>f.feature)}async _createIdentifyParameters(e,r,t){const{floors:s,layer:i,timeExtent:f,view:{spatialReference:o,scale:y}}=this.layerView;if(!r.length)return null;await Promise.all(r.map(({sublayer:S})=>S.load(t).catch(()=>{})));const c=Math.min(xe("mapservice-popup-identify-max-tolerance"),i.allSublayers.reduce((S,_)=>_.renderer?H({renderer:_.renderer,pointerType:t==null?void 0:t.pointerType}):S,2)),l=this.createFetchPopupFeaturesQueryGeometry(e,c),h=$e(y,o),p=Math.round(l.width/h),b=new D({xmin:l.center.x-h*p,ymin:l.center.y-h*p,xmax:l.center.x+h*p,ymax:l.center.y+h*p,spatialReference:l.spatialReference});return new C({floors:s,gdbVersion:"gdbVersion"in i?i.gdbVersion:void 0,geometry:e,height:p,layerOption:"popup",mapExtent:b,returnGeometry:!0,spatialReference:o,sublayers:i.sublayers,timeExtent:f,tolerance:c,width:p})}async _fetchPopupFeaturesUsingQueries(e,r,t){const{layerView:{floors:s,timeExtent:i}}=this,f=r.map(async({sublayer:o,popupTemplate:y})=>{var V,G,w;if(await o.load(t).catch(()=>{}),o.capabilities&&!o.capabilities.operations.supportsQuery)return[];const c=o.createQuery(),l=H({renderer:o.renderer,pointerType:t==null?void 0:t.pointerType}),h=this.createFetchPopupFeaturesQueryGeometry(e,l),p=new Set,[b]=await Promise.all([Pe(o,y),(V=o.renderer)==null?void 0:V.collectRequiredFields(p,o.fieldsIndex)]);M(t),Se(p,o.fieldsIndex,b);const S=Array.from(p).sort();c.geometry=h,c.outFields=S,c.timeExtent=i;const _=R(s,o);if(c.where=B(c.where,_),((G=o.capabilities)==null?void 0:G.query.supportsOrderBy)&&((w=o.orderBy)==null?void 0:w[0])){const $=o.orderBy[0],E=!$.valueExpression&&$.field,j=$.order==="ascending"?"asc":"desc";E&&(c.orderByFields=[`${E} ${j}`])}const m=this._getTargetResolution(h.width/l),P=await Te(y);M(t);const v=o.geometryType==="point"||P&&P.arcadeUtils.hasGeometryOperations(y);v||(c.maxAllowableOffset=m);let{features:g}=await o.queryFeatures(c,t);const x=v?0:m;g=await He(o,g,t);for(const $ of g)this._featuresResolutions.set($,x);return g});return(await Promise.allSettled(f)).reduce((o,y)=>y.status==="fulfilled"?[...o,...y.value]:o,[]).filter(Q)}};function Ue(a,e,r){const t=[];if(!a)return t;const s=i=>{const f=i.minScale===0||e<=i.minScale,o=i.maxScale===0||e>=i.maxScale;if(i.visible&&f&&o){if(i.sublayers)i.sublayers.forEach(s);else if(i.popupEnabled){const y=Oe(i,{...r,defaultPopupTemplateEnabled:!1});y!=null&&t.unshift({sublayer:i,popupTemplate:y})}}};return a.map(s),t}function Te(a){var e;return(e=a.expressionInfos)!=null&&e.length||Array.isArray(a.content)&&a.content.some(r=>r.type==="expression")?Fe():Promise.resolve()}async function Me(a,e){var r,t;if((t=(r=a.capabilities)==null?void 0:r.operations)!=null&&t.supportsQuery)return!0;try{return await Promise.any(e.map(({sublayer:s})=>s.load().then(()=>s.capabilities.operations.supportsQuery)))}catch{return!1}}async function He(a,e,r){const t=a.renderer;return t&&"defaultSymbol"in t&&!t.defaultSymbol&&(e=t.valueExpression?await Promise.all(e.map(s=>t.getSymbolAsync(s,r).then(i=>i?s:null))).then(s=>s.filter(i=>i!=null)):e.filter(s=>t.getSymbol(s)!=null)),e}n([u({constructOnly:!0})],O.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),n([u({constructOnly:!0})],O.prototype,"layerView",void 0),n([u({constructOnly:!0})],O.prototype,"highlightGraphics",void 0),n([u({constructOnly:!0})],O.prototype,"highlightGraphicUpdated",void 0),n([u({constructOnly:!0})],O.prototype,"updatingHandles",void 0),n([u()],O.prototype,"_updateContext",null),O=n([A("esri.views.layers.support.MapServiceLayerViewHelper")],O);export{O as P,Je as S,ze as i};
//# sourceMappingURL=MapServiceLayerViewHelper-CW6MIFJg.js.map
