const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/mediaLayerUtils-iDZD-3a3.js","assets/utils-CYM9l9Oc.js","assets/index-GOO0DjDp.js","assets/index-D7_X1F0b.css","assets/originUtils-D69mHv66.js","assets/multiOriginJSONSupportUtils-C0wm8_Yw.js","assets/jsonContext-CbvIEB6E.js","assets/saveUtils-CGbtHkHp.js","assets/resourceUtils-DW9YqCr8.js","assets/resourceUtils-CVHf2dlv.js"])))=>i.map(i=>d[i]);
import{a1 as mt,M as r,O as P,gn as Ke,di as X,W as k,N as c,T as f,cA as ft,aP as Oe,s as b,iP as R,aO as ne,dc as ie,aV as fe,P as yt,aY as Se,cW as gt,iQ as Ce,iR as xt,d1 as _t,d9 as te,iS as vt,cI as Xe,dL as Ye,w as Pt,c$ as je,d3 as qe,d0 as wt,d2 as Qe,hu as Le,d4 as Ee,iT as $t,U as Ze,cx as Rt,aS as bt,bk as It,b8 as Ot,iU as St,ai as Lt,iV as Ve,av as Et,ay as Mt,e5 as Tt,aw as Ct,ax as et,iW as jt,iX as Vt,iY as Nt,iZ as Q,bE as Ht,gY as Re,c8 as At,hp as Wt,dv as Ne,i_ as zt,ac as me,i$ as Ut,bi as Gt,bF as kt,cd as Bt,fS as Ft,ck as Jt,ag as Dt,cl as Kt,j0 as Xt,cD as Yt,cH as qt,cF as Qt,cG as Zt,dM as en,f0 as ce,du as tn,cS as nn,_ as on}from"./index-GOO0DjDp.js";import{u as tt,i as nt,c as ot,r as He,s as sn}from"./mat3-C-OMcVdC.js";import{e as B,t as rn}from"./mat3f64-q3fE-ZOt.js";import{o as L,I as K,_ as Ae}from"./vec2-c1cMo5Hj.js";import{o as st,N as it}from"./vec32-Bq8LfEfc.js";import{n as O,r as ue}from"./vec2f64-DA6GkJuH.js";import{p as ln}from"./imageUtils-B0pXyw1G.js";import{p as an}from"./resourceExtension-D9QCxwZq.js";import{o as cn}from"./BoundsStore-DCDApa5p.js";import"./PooledRBush-CIyRTnDT.js";import"./quickselect-QQC62dOK.js";const v=mt(),F=B(),Pe=B(),We=B();function E(e,t,n){return st(v,t[0],t[1],1),it(v,v,tt(F,n)),v[2]===0?L(e,v[0],v[1]):L(e,v[0]/v[2],v[1]/v[2])}function rt(e,t,n){return ze(Pe,t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7]),ze(We,n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7]),nt(e,ot(Pe,Pe),We),e[8]!==0&&(e[0]/=e[8],e[1]/=e[8],e[2]/=e[8],e[3]/=e[8],e[4]/=e[8],e[5]/=e[8],e[6]/=e[8],e[7]/=e[8],e[8]/=e[8]),e}function ze(e,t,n,o,s,i,l,a,u){He(e,t,o,i,n,s,l,1,1,1),st(v,a,u,1),ot(F,e);const[p,h,d]=it(v,v,tt(F,F));return He(F,p,0,0,0,h,0,0,0,d),nt(e,F,e)}let be=class extends Ke{projectOrWarn(e,t){if(e==null)return e;const{geometry:n,pending:o}=X(e,t);return o?null:o||n?n:(k.getLogger(this).warn("geometry could not be projected to the spatial reference",{georeference:this,geometry:e,sourceSpatialReference:e.spatialReference,targetSpatialReference:t}),null)}};be=r([P("esri.layers.support.GeoreferenceBase")],be);const oe=be,we=B(),m=O();let Z=class extends yt{};r([c({type:Number,json:{write:!0}})],Z.prototype,"x",void 0),r([c({type:Number,json:{write:!0}})],Z.prototype,"y",void 0),Z=r([P("esri.layers.support.ControlPointsGeoreference.ControlPointJSONType")],Z);let ee=class extends Ke{constructor(){super(...arguments),this.sourcePoint=null,this.mapPoint=null}};r([c()],ee.prototype,"sourcePoint",void 0),r([c({type:f})],ee.prototype,"mapPoint",void 0),ee=r([P("esri.layers.support.ControlPointsGeoreference.ControlPoint")],ee);let w=class extends ft(oe){constructor(t){super(t),this.controlPoints=null,this.height=0,this.type="control-points",this.width=0}readControlPoints(t,n){const o=Oe.fromJSON(n.spatialReference),s=rn(...n.coefficients,1);return t.map(i=>(L(m,i.x,i.y),E(m,m,s),{sourcePoint:i,mapPoint:new f({x:m[0],y:m[1],spatialReference:o})}))}writeControlPoints(t,n,o,s){if(this.transform!=null)t!=null&&_(t[0])&&(n.controlPoints=t.map(i=>{const l=i.sourcePoint;return{x:l.x,y:l.y}}),n.spatialReference=t[0].mapPoint.spatialReference.toJSON(),n.coefficients=this.transform.slice(0,8));else{const i=new b("web-document-write:invalid-georeference","Invalid 'controlPoints', 'width', 'height' configuration. Make sure the parent media element is loaded i.e. the ImageElement or VideoElement set as 'MediaLayer.source'.",{layer:s==null?void 0:s.layer,georeference:this});s!=null&&s.messages?s.messages.push(i):k.getLogger(this).error(i.name,i.message)}}get coords(){if(this.controlPoints==null)return null;const t=this._updateTransform(we);if(t==null||!_(this.controlPoints[0]))return null;const n=this.controlPoints[0].mapPoint.spatialReference;return mn(t,this.width,this.height,n)}set coords(t){if(this.controlPoints==null||!_(this.controlPoints[0]))return;const n=this.controlPoints[0].mapPoint.spatialReference;if((t=this.projectOrWarn(t,n))==null)return;const{width:o,height:s}=this,{rings:[[i,l,a,u]]}=t,p={sourcePoint:R(0,s),mapPoint:new f({x:i[0],y:i[1],spatialReference:n})},h={sourcePoint:R(0,0),mapPoint:new f({x:l[0],y:l[1],spatialReference:n})},d={sourcePoint:R(o,0),mapPoint:new f({x:a[0],y:a[1],spatialReference:n})},y={sourcePoint:R(o,s),mapPoint:new f({x:u[0],y:u[1],spatialReference:n})};_(p)&&_(h)&&_(d)&&_(y)&&(Ue(we,p,h,d,y),this.controlPoints=this.controlPoints.map(({sourcePoint:x})=>(L(m,x.x,x.y),E(m,m,we),{sourcePoint:x,mapPoint:new f({x:m[0],y:m[1],spatialReference:n})})))}get inverseTransform(){return this.transform==null?null:sn(B(),this.transform)}get transform(){return this._updateTransform()}toMap(t){if(t==null||this.transform==null||this.controlPoints==null||!_(this.controlPoints[0]))return null;L(m,t.x,t.y);const n=this.controlPoints[0].mapPoint.spatialReference;return E(m,m,this.transform),new f({x:m[0],y:m[1],spatialReference:n})}toSource(t){if(t==null||this.inverseTransform==null||this.controlPoints==null||!_(this.controlPoints[0]))return null;const n=this.controlPoints[0].mapPoint.spatialReference;return t=t.normalize(),(t=X(t,n).geometry)==null?null:(L(m,t.x,t.y),E(m,m,this.inverseTransform),R(m[0],m[1]))}toSourceNormalized(t){const n=this.toSource(t);return n!=null&&(n.x/=this.width,n.y/=this.height),n}_updateTransform(t){const{controlPoints:n,width:o,height:s}=this;if(!(n!=null&&o>0&&s>0))return null;const[i,l,a,u]=n;if(!_(i))return null;const p=i.mapPoint.spatialReference,h=this._projectControlPoint(l,p),d=this._projectControlPoint(a,p),y=this._projectControlPoint(u,p);if(!h.valid||!d.valid||!y.valid||!_(h.controlPoint))return null;t==null&&(t=B());let x=null;return x=_(d.controlPoint)&&_(y.controlPoint)?Ue(t,i,h.controlPoint,d.controlPoint,y.controlPoint):_(d.controlPoint)?pn(t,i,h.controlPoint,d.controlPoint):un(t,i,h.controlPoint),x.every(ye=>ye===0)?null:x}_projectControlPoint(t,n){if(!_(t))return{valid:!0,controlPoint:t};const{sourcePoint:o,mapPoint:s}=t,{geometry:i,pending:l}=X(s,n);return l?{valid:!1,controlPoint:null}:l||i?{valid:!0,controlPoint:{sourcePoint:o,mapPoint:i}}:(k.getLogger(this).warn("map point could not be projected to the spatial reference",{georeference:this,controlPoint:t,sourceSpatialReference:s.spatialReference,targetSpatialReference:n}),{valid:!1,controlPoint:null})}};function _(e){return(e==null?void 0:e.sourcePoint)!=null&&e.mapPoint!=null}r([c({type:[ee],json:{write:{allowNull:!1,isRequired:!0,target:{controlPoints:{type:[Z]},coefficients:{type:[Number]},spatialReference:{type:Oe}}}}})],w.prototype,"controlPoints",void 0),r([ne("controlPoints")],w.prototype,"readControlPoints",null),r([ie("controlPoints")],w.prototype,"writeControlPoints",null),r([c({clonable:!1})],w.prototype,"coords",null),r([c({type:Number,nonNullable:!0,json:{write:!0}})],w.prototype,"height",void 0),r([c({readOnly:!0})],w.prototype,"inverseTransform",null),r([c({readOnly:!0})],w.prototype,"transform",null),r([c({type:Number,nonNullable:!0,json:{write:!0}})],w.prototype,"width",void 0),w=r([P("esri.layers.support.ControlPointsGeoreference")],w);const M=O(),T=O(),U=O(),H=O(),C=O(),j=O(),G=O(),A=O(),pe=Math.PI/2;function V(e,t,n){L(e,n.sourcePoint.x,n.sourcePoint.y),L(t,n.mapPoint.x,n.mapPoint.y)}function un(e,t,n){return V(M,C,t),V(T,j,n),K(U,T,M,pe),K(H,M,T,pe),K(G,j,C,-pe),K(A,C,j,-pe),Me(e,M,T,U,H,C,j,G,A)}function pn(e,t,n,o){return V(M,C,t),V(T,j,n),V(U,G,o),Ae(H,M,T,.5),K(H,U,H,Math.PI),Ae(A,C,j,.5),K(A,G,A,Math.PI),Me(e,M,T,U,H,C,j,G,A)}function Ue(e,t,n,o,s){return V(M,C,t),V(T,j,n),V(U,G,o),V(H,A,s),Me(e,M,T,U,H,C,j,G,A)}const hn=new Array(8).fill(0),dn=new Array(8).fill(0);function Ge(e,t,n,o,s){return e[0]=t[0],e[1]=t[1],e[2]=n[0],e[3]=n[1],e[4]=o[0],e[5]=o[1],e[6]=s[0],e[7]=s[1],e}function Me(e,t,n,o,s,i,l,a,u){return rt(e,Ge(hn,t,n,o,s),Ge(dn,i,l,a,u))}function mn(e,t,n,o){const s=ue(0,n),i=ue(0,0),l=ue(t,0),a=ue(t,n);return E(s,s,e),E(i,i,e),E(l,l,e),E(a,a,e),new fe({rings:[[s,i,l,a,s]],spatialReference:o})}const se=w,Y=O();let N=class extends oe{constructor(t){super(t),this.bottomLeft=null,this.bottomRight=null,this.topLeft=null,this.topRight=null,this.type="corners"}get coords(){let{topLeft:t,topRight:n,bottomLeft:o,bottomRight:s}=this;if(t==null||n==null||o==null||s==null)return null;const i=t.spatialReference;return n=this.projectOrWarn(n,i),o=this.projectOrWarn(o,i),s=this.projectOrWarn(s,i),n==null||o==null||s==null?null:new fe({rings:[[[o.x,o.y],[t.x,t.y],[n.x,n.y],[s.x,s.y],[o.x,o.y]]],spatialReference:i})}set coords(t){const{topLeft:n}=this;if(n==null)return;const o=n.spatialReference;if((t=this.projectOrWarn(t,o))==null)return;const{rings:[[s,i,l,a]]}=t;this.bottomLeft=new f({x:s[0],y:s[1],spatialReference:o}),this.topLeft=new f({x:i[0],y:i[1],spatialReference:o}),this.topRight=new f({x:l[0],y:l[1],spatialReference:o}),this.bottomRight=new f({x:a[0],y:a[1],spatialReference:o})}toSourceNormalized(t){const{topLeft:n,topRight:o,bottomRight:s,bottomLeft:i}=this;if(t==null||n==null||o==null||s==null||i==null)return null;const l=n.spatialReference;t=t.normalize();const a=X(t,l).geometry;if(a==null)return null;L(Y,a.x,a.y);const u=rt(B(),[n.x,n.y,i.x,i.y,o.x,o.y,s.x,s.y],[0,0,0,1,1,0,1,1]);return E(Y,Y,u),R(Y[0],Y[1])}};r([c({clonable:!1})],N.prototype,"coords",null),r([c({type:f})],N.prototype,"bottomLeft",void 0),r([c({type:f})],N.prototype,"bottomRight",void 0),r([c({type:f})],N.prototype,"topLeft",void 0),r([c({type:f})],N.prototype,"topRight",void 0),N=r([P("esri.layers.support.CornersGeoreference")],N);const fn=N;let J=class extends oe{constructor(t){super(t),this.extent=null,this.rotation=0,this.type="extent-and-rotation"}get coords(){if(this.extent==null)return null;const{xmin:t,ymin:n,xmax:o,ymax:s,spatialReference:i}=this.extent;let l;if(this.rotation){const{x:a,y:u}=this.extent.center,p=$e(a,u,this.rotation);l=[p(t,n),p(t,s),p(o,s),p(o,n)],l.push(l[0])}else l=[[t,n],[t,s],[o,s],[o,n],[t,n]];return new fe({rings:[l],spatialReference:i})}set coords(t){if(t==null||this.extent==null)return;const n=this.extent.spatialReference;if(t=this.projectOrWarn(t,n),(t==null?void 0:t.extent)==null)return;const{rings:[[o,s,i]],extent:{center:{x:l,y:a}}}=t,u=gt(Math.PI/2-Math.atan2(s[1]-o[1],s[0]-o[0])),p=$e(l,a,-u),[h,d]=p(o[0],o[1]),[y,x]=p(i[0],i[1]);this.extent=new Se({xmin:h,ymin:d,xmax:y,ymax:x,spatialReference:n}),this.rotation=u}toSourceNormalized(t){const{extent:n,rotation:o}=this;if(t==null||n==null)return null;const{xmin:s,ymin:i,xmax:l,ymax:a,center:u,spatialReference:p}=n;t=t.normalize();const h=X(t,p).geometry;if(h==null)return null;let d=h.x,y=h.y;return o&&([d,y]=$e(u.x,u.y,-o)(d,y)),R(Ce(d,s,l,0,1),Ce(y,a,i,0,1))}};function $e(e,t,n){const o=xt(n),s=Math.cos(o),i=Math.sin(o);return(l,a)=>[s*(l-e)+i*(a-t)+e,s*(a-t)-i*(l-e)+t]}r([c({clonable:!1})],J.prototype,"coords",null),r([c({type:Se})],J.prototype,"extent",void 0),r([c({type:Number})],J.prototype,"rotation",void 0),J=r([P("esri.layers.support.ExtentAndRotationGeoreference")],J);const yn=J;function gn(e){return(e==null?void 0:e.type)==="media"}function lt(e,t){const n=_t(t);return gn(e)&&!!e.portalItem&&n!=null&&n>te.PORTAL_ITEM}function xn(e,t,n){var p;if(!e||e.type==="control-points")return e;const{coords:o}=e;if(((p=o==null?void 0:o.rings[0])==null?void 0:p.length)!==5)return null;const[s,i,l,a]=o.rings[0],{spatialReference:u}=o;return new se({controlPoints:[{mapPoint:new f({x:s[0],y:s[1],spatialReference:u}),sourcePoint:R(0,n)},{mapPoint:new f({x:i[0],y:i[1],spatialReference:u}),sourcePoint:R(0,0)},{mapPoint:new f({x:l[0],y:l[1],spatialReference:u}),sourcePoint:R(t,0)},{mapPoint:new f({x:a[0],y:a[1],spatialReference:u}),sourcePoint:R(t,n)}],width:t,height:n})}function at(e,t,n){return{enabled:!lt(n==null?void 0:n.layer,n==null?void 0:n.origin),ignoreOrigin:!0}}const ct={json:{name:"url",type:String,write:{overridePolicy:at}}},ut={readOnly:!0,json:{read:!1,write:{target:"mediaType",overridePolicy:at}}},_n={types:{key:"type",base:oe,typeMap:{"control-points":se,corners:fn,"extent-and-rotation":yn}},json:{types:{key:"type",base:oe,typeMap:{"control-points":se}},write:{overridePolicy:()=>({enabled:!0,ignoreOrigin:!0})}}};let z=class extends vt(Xe(Ye)){constructor(e){super(e),this.georeference=null,this.opacity=1}readGeoreference(e){return se.fromJSON(e)}writeGeoreference(e,t,n,o){var l;const s=(l=o==null?void 0:o.resources)==null?void 0:l.pendingOperations,i=()=>{var u;const a=xn(this.georeference,this.contentWidth,this.contentHeight);if(a){if(e.type!=="control-points"&&k.getLogger(this).warn(`only georeference of type 'control-points' may be persisted. The georeference of type '${e.type}' has been automatically converted.`),((u=a.controlPoints)==null?void 0:u.length)!==4&&(o==null?void 0:o.messages))return void o.messages.push(new b("property:unsupported","only 'control-points' georeference with 4 control points may be persisted."));t[n]=a.write({},o)}};if(e.type!=="control-points"&&!this.loaded&&s)return t[n]={},void s.push(this.load().then(i));i()}get contentWidth(){return 0}get contentHeight(){return 0}toSource(e){const{georeference:t,contentWidth:n,contentHeight:o}=this;if(e==null||t==null||n===0||o===0)return null;const s=t.toSourceNormalized(e);return s==null?null:(s.x*=n,s.y*=o,s)}};r([c(_n)],z.prototype,"georeference",void 0),r([ne("georeference")],z.prototype,"readGeoreference",null),r([ie("georeference")],z.prototype,"writeGeoreference",null),r([c({json:{read:!1,write:!1}})],z.prototype,"opacity",void 0),z=r([P("esri.layers.support.MediaElementBase")],z);const Te=z;let $=class extends Te{constructor(t){super(t),this.animationOptions=null,this.content=null,this.image=null,this.type="image",this.image=null}load(){const t=this.image;if(typeof t=="string"){const n=ln(t).then(o=>{this._set("content",o)});this.addResolvingPromise(n)}else if(t instanceof HTMLImageElement){const n=t.decode().then(()=>{this._set("content",t)});this.addResolvingPromise(n)}else t?this._set("content",t):this.addResolvingPromise(Promise.reject(new b("image-element:invalid-image-type","Invalid image type",{image:t})));return Promise.resolve(this)}get contentWidth(){return this.content==null?0:this.content instanceof HTMLImageElement?this.content.naturalWidth:this.content.width}get contentHeight(){return this.content==null?0:this.content instanceof HTMLImageElement?this.content.naturalHeight:this.content.height}readImage(t,n,o){return Pt(n.url,o)}writeImage(t,n,o,s){if(t==null)return;const i=s==null?void 0:s.portalItem,l=s==null?void 0:s.resources;if(!i||!l)return void(typeof t=="string"&&(n[o]=je(t,s)));const a=vn(t)?t:null;if(a){if(qe(a)==null)return void(n[o]=a);const u=je(a,{...s,verifyItemRelativeUrls:s!=null&&s.verifyItemRelativeUrls?{writtenUrls:s.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},wt.NO);if(i&&u&&!Qe(u))return l.toKeep.push({resource:i.resourceFromPath(u),compress:!1}),void(n[o]=u)}n[o]="<pending>",l.pendingOperations.push(Pn(t).then(u=>{const p=$n(u,i);n[o]=p.itemRelativeUrl,l.toAdd.push({resource:p,content:{type:"blob",blob:u},compress:!1,finish:h=>{this.image=h.url}})}))}};r([c()],$.prototype,"animationOptions",void 0),r([c({readOnly:!0})],$.prototype,"content",void 0),r([c({readOnly:!0})],$.prototype,"contentWidth",null),r([c({readOnly:!0})],$.prototype,"contentHeight",null),r([c(ct)],$.prototype,"image",void 0),r([ne("image",["url"])],$.prototype,"readImage",null),r([ie("image")],$.prototype,"writeImage",null),r([c(ut)],$.prototype,"type",void 0),$=r([P("esri.layers.support.ImageElement")],$);const pt=$;function vn(e){return typeof e=="string"&&!Le(e)&&!Ee(e)}async function Pn(e){return typeof e=="string"?Le(e)?$t(e):(await Ze(e,{responseType:"blob"})).data:new Promise(t=>wn(e).toBlob(t))}function wn(e){if(e instanceof HTMLCanvasElement)return e;const t=e instanceof HTMLImageElement?e.naturalWidth:e.width,n=e instanceof HTMLImageElement?e.naturalHeight:e.height,o=document.createElement("canvas"),s=o.getContext("2d");return o.width=t,o.height=n,e instanceof HTMLImageElement?s.drawImage(e,0,0,e.width,e.height):e instanceof ImageData&&s.putImageData(e,0,0),o}function $n(e,t){const n=Rt(),o=`${bt("media",n)}.${an({type:"blob",blob:e})}`;return t.resourceFromPath(o)}function Rn(e){return bn(e,!0)}function bn(e,t){if(e==null)return null;const n=e.spatialReference,o=Ot(n),s=St(e)?e.toJSON():e;if(!o)return s;const i=Lt(n)?102100:4326,l=Ve[i].maxX,a=Ve[i].minX;if(Et(s))return ke(s,l,a);if(Mt(s))return s.points=s.points.map(u=>ke(u,l,a)),s;if(Tt(s))return In(s,o);if(Ct(s)||et(s)){const u=jt(Sn,s),p={xmin:u[0],ymin:u[1],xmax:u[2],ymax:u[3]},h=Q(p.xmin,a)*(2*l),d=h===0?s:Vt(s,h);return p.xmin+=h,p.xmax+=h,p.xmax>l?Fe(d,l,t):p.xmin<a?Fe(d,a,t):d}return s}function In(e,t){if(!t)return e;const n=On(e,t).map(o=>o.extent);return n.length<2?n[0]||e:n.length>2?(e.xmin=t.valid[0],e.xmax=t.valid[1],e):{rings:n.map(o=>[[o.xmin,o.ymin],[o.xmin,o.ymax],[o.xmax,o.ymax],[o.xmax,o.ymin],[o.xmin,o.ymin]])}}function ke(e,t,n){if(Array.isArray(e)){const o=e[0];if(o>t){const s=Q(o,t);e[0]=o+s*(-2*t)}else if(o<n){const s=Q(o,n);e[0]=o+s*(-2*n)}}else{const o=e.x;if(o>t){const s=Q(o,t);e.x+=s*(-2*t)}else if(o<n){const s=Q(o,n);e.x+=s*(-2*n)}}return e}function On(e,t){const n=[],{ymin:o,ymax:s,xmin:i,xmax:l}=e,a=e.xmax-e.xmin,[u,p]=t.valid,{x:h,frameId:d}=Be(e.xmin,t),{x:y,frameId:x}=Be(e.xmax,t),ye=h===y&&a>0;if(a>2*p){const ge={xmin:i<l?h:y,ymin:o,xmax:p,ymax:s},xe={xmin:u,ymin:o,xmax:i<l?y:h,ymax:s},_e={xmin:0,ymin:o,xmax:p,ymax:s},ve={xmin:u,ymin:o,xmax:0,ymax:s},re=[],le=[];he(ge,_e)&&re.push(d),he(ge,ve)&&le.push(d),he(xe,_e)&&re.push(x),he(xe,ve)&&le.push(x);for(let ae=d+1;ae<x;ae++)re.push(ae),le.push(ae);n.push(new W(ge,[d]),new W(xe,[x]),new W(_e,re),new W(ve,le))}else h>y||ye?n.push(new W({xmin:h,ymin:o,xmax:p,ymax:s},[d]),new W({xmin:u,ymin:o,xmax:y,ymax:s},[x])):n.push(new W({xmin:h,ymin:o,xmax:y,ymax:s},[d]));return n}function Be(e,t){const[n,o]=t.valid,s=2*o;let i,l=0;return e>o?(i=Math.ceil(Math.abs(e-o)/s),e-=i*s,l=i):e<n&&(i=Math.ceil(Math.abs(e-n)/s),e+=i*s,l=-i),{x:e,frameId:l}}function he(e,t){const{xmin:n,ymin:o,xmax:s,ymax:i}=t;return de(e,n,o)&&de(e,n,i)&&de(e,s,i)&&de(e,s,o)}function de(e,t,n){return t>=e.xmin&&t<=e.xmax&&n>=e.ymin&&n<=e.ymax}function Fe(e,t,n=!0){const o=!et(e);if(o&&Nt(e),n)return new Ln().cut(e,t);const s=o?e.rings:e.paths,i=o?4:2,l=s.length,a=-2*t;for(let u=0;u<l;u++){const p=s[u];if(p&&p.length>=i){const h=[];for(const d of p)h.push([d[0]+a,d[1]]);s.push(h)}}return o?e.rings=s:e.paths=s,e}class W{constructor(t,n){this.extent=t,this.frameIds=n}}const Sn=It();class Ln{constructor(){this._linesIn=[],this._linesOut=[]}cut(t,n){let o;if(this._xCut=n,t.rings)this._closed=!0,o=t.rings,this._minPts=4;else{if(!t.paths)return null;this._closed=!1,o=t.paths,this._minPts=2}for(const i of o){if(!i||i.length<this._minPts)continue;let l=!0;for(const a of i)l?(this.moveTo(a),l=!1):this.lineTo(a);this._closed&&this.close()}this._pushLineIn(),this._pushLineOut(),o=[];for(const i of this._linesIn)i&&i.length>=this._minPts&&o.push(i);const s=-2*this._xCut;for(const i of this._linesOut)if(i&&i.length>=this._minPts){for(const l of i)l[0]+=s;o.push(i)}return this._closed?t.rings=o:t.paths=o,t}moveTo(t){this._pushLineIn(),this._pushLineOut(),this._prevSide=this._side(t[0]),this._moveTo(t[0],t[1],this._prevSide),this._prevPt=t,this._firstPt=t}lineTo(t){const n=this._side(t[0]);if(n*this._prevSide==-1){const o=this._intersect(this._prevPt,t);this._lineTo(this._xCut,o,0),this._prevSide=0,this._lineTo(t[0],t[1],n)}else this._lineTo(t[0],t[1],n);this._prevSide=n,this._prevPt=t}close(){const t=this._firstPt,n=this._prevPt;t[0]===n[0]&&t[1]===n[1]||this.lineTo(t),this._checkClosingPt(this._lineIn),this._checkClosingPt(this._lineOut)}_moveTo(t,n,o){this._closed?(this._lineIn.push([o<=0?t:this._xCut,n]),this._lineOut.push([o>=0?t:this._xCut,n])):(o<=0&&this._lineIn.push([t,n]),o>=0&&this._lineOut.push([t,n]))}_lineTo(t,n,o){this._closed?(Je(this._lineIn,o<=0?t:this._xCut,n),Je(this._lineOut,o>=0?t:this._xCut,n)):o<0?(this._prevSide===0&&this._pushLineOut(),this._lineIn.push([t,n])):o>0?(this._prevSide===0&&this._pushLineIn(),this._lineOut.push([t,n])):this._prevSide<0?(this._lineIn.push([t,n]),this._lineOut.push([t,n])):this._prevSide>0&&(this._lineOut.push([t,n]),this._lineIn.push([t,n]))}_checkClosingPt(t){const n=t.length;n>3&&t[0][0]===this._xCut&&t[n-2][0]===this._xCut&&t[1][0]===this._xCut&&(t[0][1]=t[n-2][1],t.pop())}_side(t){return t<this._xCut?-1:t>this._xCut?1:0}_intersect(t,n){const o=(this._xCut-t[0])/(n[0]-t[0]);return t[1]+o*(n[1]-t[1])}_pushLineIn(){this._lineIn&&this._lineIn.length>=this._minPts&&this._linesIn.push(this._lineIn),this._lineIn=[]}_pushLineOut(){this._lineOut&&this._lineOut.length>=this._minPts&&this._linesOut.push(this._lineOut),this._lineOut=[]}}function Je(e,t,n){const o=e.length;o>1&&e[o-1][0]===t&&e[o-2][0]===t?e[o-1][1]=n:e.push([t,n])}let S=class extends Ht{constructor(e){super(e)}get bounds(){const e=this.coords;return(e==null?void 0:e.extent)==null?null:Re(e.extent)}get coords(){var t;const e=(t=this.element.georeference)==null?void 0:t.coords;return X(e,this.spatialReference).geometry}get normalizedCoords(){return fe.fromJSON(Rn(this.coords))}get normalizedBounds(){const e=this.normalizedCoords!=null?this.normalizedCoords.extent:null;return e!=null?Re(e):null}};r([c()],S.prototype,"spatialReference",void 0),r([c()],S.prototype,"element",void 0),r([c()],S.prototype,"bounds",null),r([c()],S.prototype,"coords",null),r([c()],S.prototype,"normalizedCoords",null),r([c()],S.prototype,"normalizedBounds",null),S=r([P("esri.layers.support.MediaElementView")],S);let I=class extends Te{constructor(e){super(e),this.autoplay=!0,this.content=null,this.type="video"}load(){const e=this.video;return typeof e=="string"?this.addResolvingPromise(this._preProcessVideoUrl(e).then(t=>{const n=document.createElement("video");return n.src=t,n.crossOrigin="anonymous",n.autoplay=!0,n.muted=!0,n.loop=!0,n.playsInline=!0,this._loadVideo(n).then(()=>{this._set("content",n)})})):e instanceof HTMLVideoElement?this.addResolvingPromise(this._loadVideo(e).then(()=>{this._set("content",e)})):this.addResolvingPromise(Promise.reject(new b("video-element:invalid-video-type","Invalid video type",{video:e}))),Promise.resolve(this)}get contentWidth(){var e;return((e=this.content)==null?void 0:e.videoWidth)??0}get contentHeight(){var e;return((e=this.content)==null?void 0:e.videoHeight)??0}set video(e){this.loadStatus==="not-loaded"?this._set("video",e):k.getLogger(this).error("#video","video cannot be changed after the element is loaded.")}writeVideo(e,t,n,o){if(!e)return void((o==null?void 0:o.messages)&&o.messages.push(new b("video-element:unsupported-video","video source is missing")));const s=En(e)?e:null;if(!s)return void((o==null?void 0:o.messages)&&o.messages.push(new b("video-element:unsupported-video","video source must be an absolute url")));!Qe(s)&&(o!=null&&o.blockedRelativeUrls)&&o.blockedRelativeUrls.push(s);const i=At(s);qe(i)?o!=null&&o.messages&&o.messages.push(new b("video-element:unsupported-video","video source cannot be an item resource")):t[n]=i}async _preProcessVideoUrl(e){if(Wt(e))return Ne(e);try{return await Ze(e,{method:"head"}),e}catch{return Ne(e,!0)}}_loadVideo(e){return new Promise((t,n)=>{const o=zt(e,"canplay",()=>{this.removeHandles("canplay"),this.autoplay?e.play().then(t,n):t()});this.addHandles(o,"canplay"),e.crossOrigin!=="anonymous"&&(e.crossOrigin="anonymous",Ee(e.src)||(e.src=e.src))})}};r([c()],I.prototype,"autoplay",void 0),r([c({readOnly:!0})],I.prototype,"content",void 0),r([c({readOnly:!0})],I.prototype,"contentWidth",null),r([c({readOnly:!0})],I.prototype,"contentHeight",null),r([c(ct)],I.prototype,"video",null),r([ie("video")],I.prototype,"writeVideo",null),r([c(ut)],I.prototype,"type",void 0),I=r([P("esri.layers.support.VideoElement")],I);const ht=I;function En(e){return typeof e=="string"&&!Le(e)&&!Ee(e)}const Mn={key:"type",defaultKeyValue:"image",base:Te,typeMap:{image:pt,video:ht}},De=me.ofType(Mn);let D=class extends Ye.LoadableMixin(Ut(Gt.EventedAccessor)){constructor(e){super(e),this._index=new cn,this._elementViewsMap=new Map,this._elementsIndexes=new Map,this._elementsChangedHandler=t=>{for(const o of t.removed){const s=this._elementViewsMap.get(o);this._elementViewsMap.delete(o),this._index.delete(s),this.removeHandles(s),s.destroy(),this.notifyChange("fullExtent")}const{spatialReference:n}=this;for(const o of t.added){if(this._elementViewsMap.get(o))continue;const s=new S({spatialReference:n,element:o});this._elementViewsMap.set(o,s);const i=kt(()=>s.coords,()=>this._updateIndexForElement(s,!1));this._updateIndexForElement(s,!0),this.addHandles(i,s)}this._elementsIndexes.clear(),this.elements.forEach((o,s)=>this._elementsIndexes.set(o,s)),this.emit("refresh")},this.elements=new De}async load(e){if(Bt(e),!this.spatialReference){const t=this.elements.find(n=>{var o;return((o=n.georeference)==null?void 0:o.coords)!=null});this._set("spatialReference",t?t.georeference.coords.spatialReference:Oe.WGS84)}return this._elementsChangedHandler({added:this.elements.items,removed:[]}),this.addHandles(this.elements.on("change",this._elementsChangedHandler)),this}destroy(){this._index.clear(),this._elementViewsMap.clear(),this._elementsIndexes.clear()}set elements(e){this._set("elements",Ft(e,this._get("elements"),De))}get fullExtent(){if(this.loadStatus==="not-loaded")return null;const e=this._index.fullBounds;return e==null?null:new Se({xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:this.spatialReference})}set spatialReference(e){this.loadStatus==="not-loaded"?this._set("spatialReference",e):k.getLogger(this).error("#spatialReference","spatialReference cannot be changed after the source is loaded.")}async queryElements(e,t){await this.load(),await Jt(e.spatialReference,this.spatialReference,null,t);const n=Dt(e.spatialReference,this.spatialReference)?e:Kt(e,this.spatialReference);if(!n)return[];const o=n.normalize(),s=[];for(const i of o)this._index.forEachInBounds(Re(i),({normalizedCoords:l,element:a})=>{l!=null&&Xt(i,l)&&s.push(a)});return s.sort((i,l)=>this._elementsIndexes.get(i)-this._elementsIndexes.get(l)),s}hasElement(e){return this.elements.includes(e)}_updateIndexForElement(e,t){const n=e.normalizedBounds,o=this._index.has(e),s=n!=null;this._index.delete(e),s&&this._index.set(e,n),this.notifyChange("fullExtent"),t||(o!==s?this.emit("refresh"):this.emit("change",{element:e.element}))}};r([c()],D.prototype,"elements",null),r([c({readOnly:!0})],D.prototype,"fullExtent",null),r([c()],D.prototype,"spatialReference",null),D=r([P("esri.layers.support.LocalMediaElementSource")],D);const q=D;function Ie(e){return typeof e=="object"&&e!=null&&"type"in e}function dt(e){return Ie(e)&&(e.type==="image"||e.type==="video")}let g=class extends Yt(qt(Qt(Zt(Xe(nn))))){constructor(e){super(e),this.effectiveSource=null,this.georeference=null,this.copyright=null,this.operationalLayerType="MediaLayer",this.spatialReference=null,this.type="media",this._debouncedSaveOperations=en(async(t,n,o)=>{const{save:s,saveAs:i}=await on(()=>import("./mediaLayerUtils-iDZD-3a3.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]));switch(t){case ce.SAVE:return s(this,n);case ce.SAVE_AS:return i(this,o,n)}}),this.source=new q}load(e){return this.addResolvingPromise(this._doLoad(e)),Promise.resolve(this)}async _doLoad(e){await this.loadFromPortal({supportedTypes:["Media Layer"]},e);let t=this.source;if(!t)throw new b("media-layer:source-missing","Set 'MediaLayer.source' before loading the layer.");const n=this._getSourceOverride(t,this.georeference);n&&(this.setAtOrigin("source",n,"web-map"),this.setAtOrigin("source",n,"web-scene"),t=n);const o=Ie(t)?new q({elements:new me([t])}):t;this._set("effectiveSource",o),this.spatialReference&&(o.spatialReference=this.spatialReference),await o.load(e),this.spatialReference=o.spatialReference}destroy(){var e,t;(e=this.effectiveSource)==null||e.destroy(),this.effectiveSource!==this.source&&((t=this.source)==null||t.destroy())}readGeoreference(e,t){return e&&"itemId"in t&&t.itemId?e:void 0}get fullExtent(){return this.loaded?this.effectiveSource.fullExtent:null}set source(e){this.loadStatus!=="loaded"&&this.loadStatus!=="failed"?this._set("source",e):k.getLogger(this).error("#source","source cannot be changed after the layer is loaded.")}castSource(e){return e?Array.isArray(e)?new q({elements:new me(e)}):e instanceof me?new q({elements:e}):e:null}readSource(e,t,n){if("itemId"in t&&t.itemId)return;const o=this._createSource(t);return o==null||o.read(t,n),o}writeSource(e,t,n,o){if(e&&e instanceof q){const s=e.elements.length;if(s!==1)return void((o==null?void 0:o.messages)&&o.messages.push(new b("media-layer:unsupported-source",`local media element source can only be persisted if it contains exactly one ImageElement, but it has ${s}.`)));e=e.elements.at(0)}dt(e)?e.write(t,o):o!=null&&o.messages&&(e?o.messages.push(new b("media-layer:unsupported-source","only media elements of type 'ImageElement' or 'VideoElement' can be persisted")):o.messages.push(new b("media-layer:unsupported-source","the media layer is missing a source")))}async save(e){return this._debouncedSaveOperations(ce.SAVE,e)}async saveAs(e,t){return this._debouncedSaveOperations(ce.SAVE_AS,t,e)}_createSource(e){if("mediaType"in e)switch(e.mediaType){case"image":return new pt;case"video":return new ht}return null}_getSourceOverride(e,t){if(Ie(e)&&this.originIdOf("source")===te.PORTAL_ITEM&&t&&(this.originIdOf("georeference")===te.WEB_MAP||this.originIdOf("georeference")===te.WEB_SCENE)){const n=e.toJSON(),o=this._createSource(n);return o.read({...n},{origin:"portal-item"}),o.read({georeference:t},{origin:"web-map"}),o.read({georeference:t},{origin:"web-scene"}),o}return null}};r([c({readOnly:!0})],g.prototype,"effectiveSource",void 0),r([c({readOnly:!0,json:{read:!1,write:!1,origins:{"web-document":{read:!0}}}})],g.prototype,"georeference",void 0),r([ne("web-document","georeference")],g.prototype,"readGeoreference",null),r([c({type:String})],g.prototype,"copyright",void 0),r([c({readOnly:!0})],g.prototype,"fullExtent",null),r([c({type:["MediaLayer"]})],g.prototype,"operationalLayerType",void 0),r([c({type:["show","hide"]})],g.prototype,"listMode",void 0),r([c({nonNullable:!0,json:{write:{enabled:!0,allowNull:!1,target:{url:{type:String},mediaType:{type:["image","video"]},georeference:{type:se}},overridePolicy(e,t,n){return{enabled:!0,allowNull:!1,ignoreOrigin:lt(this,n==null?void 0:n.origin)&&dt(e)&&!!e.georeference&&e.originIdOf("georeference")>te.PORTAL_ITEM}}}}})],g.prototype,"source",null),r([tn("source")],g.prototype,"castSource",null),r([ne("source",["url"])],g.prototype,"readSource",null),r([ie("source")],g.prototype,"writeSource",null),r([c()],g.prototype,"spatialReference",void 0),r([c({readOnly:!0})],g.prototype,"type",void 0),g=r([P("esri.layers.MediaLayer")],g);const Xn=g;export{Xn as default};
