import{jE as ne,hC as ae,aE as Re,jF as Fe,fk as ve,aR as we}from"./index-GOO0DjDp.js";import{a as It,m as O,t as H,E as Kt,o as oe,n as Zt,U as Ce,O as Ue,p as Ee,u as Jt,b as yt,I as wt,l as Oe}from"./StyleRepository-Bbt_CBxl.js";import{h as C,s as ee,o as Bt,r as mt,f as Be,a as le,e as ce,i as Ne,c as ht,p as Ut,d as $e,g as ze,_ as Ge}from"./GeometryUtils-D9Z2K2oT.js";import{t as he,a as He,c as Ke,i as je}from"./TurboLine-D2maCSm_.js";import{e as ue}from"./earcut-Lltz9D9k.js";import"./enums-V7VQdXj3.js";import"./VertexElementDescriptor-BOD-G50G.js";const Et=[["(",")"],[")","("],["<",">"],[">","<"],["[","]"],["]","["],["{","}"],["}","{"],["«","»"],["»","«"],["‹","›"],["›","‹"],["⁽","⁾"],["⁾","⁽"],["₍","₎"],["₎","₍"],["≤","≥"],["≥","≤"],["〈","〉"],["〉","〈"],["﹙","﹚"],["﹚","﹙"],["﹛","﹜"],["﹜","﹛"],["﹝","﹞"],["﹞","﹝"],["﹤","﹥"],["﹥","﹤"]],At=["آ","أ","إ","ا"],We=["ﻵ","ﻷ","ﻹ","ﻻ"],qe=["ﻶ","ﻸ","ﻺ","ﻼ"],zt=["ا","ب","ت","ث","ج","ح","خ","د","ذ","ر","ز","س","ش","ص","ض","ط","ظ","ع","غ","ف","ق","ك","ل","م","ن","ه","و","ي","إ","أ","آ","ة","ى","ل","م","ن","ه","و","ي","إ","أ","آ","ة","ى","ی","ئ","ؤ"],Ye=["ﺍ","ﺏ","ﺕ","ﺙ","ﺝ","ﺡ","ﺥ","ﺩ","ﺫ","ﺭ","ﺯ","ﺱ","ﺵ","ﺹ","ﺽ","ﻁ","ﻅ","ﻉ","ﻍ","ﻑ","ﻕ","ﻙ","ﻝ","ﻡ","ﻥ","ﻩ","ﻭ","ﻱ","ﺇ","ﺃ","ﺁ","ﺓ","ﻯ","ﯼ","ﺉ","ﺅ","ﹰ","ﹲ","ﹴ","ﹶ","ﹸ","ﹺ","ﹼ","ﹾ","ﺀ","ﺉ","ﺅ"],Ze=["ﺎ","ﺐ","ﺖ","ﺚ","ﺞ","ﺢ","ﺦ","ﺪ","ﺬ","ﺮ","ﺰ","ﺲ","ﺶ","ﺺ","ﺾ","ﻂ","ﻆ","ﻊ","ﻎ","ﻒ","ﻖ","ﻚ","ﻞ","ﻢ","ﻦ","ﻪ","ﻮ","ﻲ","ﺈ","ﺄ","ﺂ","ﺔ","ﻰ","ﯽ","ﺊ","ﺆ","ﹰ","ﹲ","ﹴ","ﹶ","ﹸ","ﹺ","ﹼ","ﹾ","ﺀ","ﺊ","ﺆ"],Je=["ﺎ","ﺒ","ﺘ","ﺜ","ﺠ","ﺤ","ﺨ","ﺪ","ﺬ","ﺮ","ﺰ","ﺴ","ﺸ","ﺼ","ﻀ","ﻄ","ﻈ","ﻌ","ﻐ","ﻔ","ﻘ","ﻜ","ﻠ","ﻤ","ﻨ","ﻬ","ﻮ","ﻴ","ﺈ","ﺄ","ﺂ","ﺔ","ﻰ","ﯿ","ﺌ","ﺆ","ﹱ","ﹲ","ﹴ","ﹷ","ﹹ","ﹻ","ﹽ","ﹿ","ﺀ","ﺌ","ﺆ"],Qe=["ﺍ","ﺑ","ﺗ","ﺛ","ﺟ","ﺣ","ﺧ","ﺩ","ﺫ","ﺭ","ﺯ","ﺳ","ﺷ","ﺻ","ﺿ","ﻃ","ﻇ","ﻋ","ﻏ","ﻓ","ﻗ","ﻛ","ﻟ","ﻣ","ﻧ","ﻫ","ﻭ","ﻳ","ﺇ","ﺃ","ﺁ","ﺓ","ﻯ","ﯾ","ﺋ","ﺅ","ﹰ","ﹲ","ﹴ","ﹶ","ﹸ","ﹺ","ﹼ","ﹾ","ﺀ","ﺋ","ﺅ"],fe=["ء","آ","أ","ؤ","إ","ا","ة","د","ذ","ر","ز","و","ى"],Xe=["ً","ً","ٌ","؟","ٍ","؟","َ","َ","ُ","ُ","ِ","ِ","ّ","ّ","ْ","ْ","ء","آ","آ","أ","أ","ؤ","ؤ","إ","إ","ئ","ئ","ئ","ئ","ا","ا","ب","ب","ب","ب","ة","ة","ت","ت","ت","ت","ث","ث","ث","ث","ج","ج","ج","ج","ح","ح","ح","ح","خ","خ","خ","خ","د","د","ذ","ذ","ر","ر","ز","ز","س","س","س","س","ش","ش","ش","ش","ص","ص","ص","ص","ض","ض","ض","ض","ط","ط","ط","ط","ظ","ظ","ظ","ظ","ع","ع","ع","ع","غ","غ","غ","غ","ف","ف","ف","ف","ق","ق","ق","ق","ك","ك","ك","ك","ل","ل","ل","ل","م","م","م","م","ن","ن","ن","ن","ه","ه","ه","ه","و","و","ى","ى","ي","ي","ي","ي","ﻵ","ﻶ","ﻷ","ﻸ","ﻹ","ﻺ","ﻻ","ﻼ","؟","؟","؟"],de=["ء","ف"],ts=["غ","ي"],es=[[0,3,0,1,0,0,0],[0,3,0,1,2,2,0],[0,3,0,17,2,0,1],[0,3,5,5,4,1,0],[0,3,21,21,4,0,1],[0,3,5,5,4,2,0]],ss=[[2,0,1,1,0,1,0],[2,0,1,1,0,2,0],[2,0,2,1,3,2,0],[2,0,2,33,3,1,1]],r=0,A=1,k=2,z=3,t=4,nt=5,$t=6,e=7,W=8,Y=9,st=10,F=11,g=12,is=13,rs=14,ns=15,as=16,os=17,D=18,ls=["UBAT_L","UBAT_R","UBAT_EN","UBAT_AN","UBAT_ON","UBAT_B","UBAT_S","UBAT_AL","UBAT_WS","UBAT_CS","UBAT_ES","UBAT_ET","UBAT_NSM","UBAT_LRE","UBAT_RLE","UBAT_PDF","UBAT_LRO","UBAT_RLO","UBAT_BN"],rt=100,cs=[rt+0,r,r,r,r,rt+1,rt+2,rt+3,A,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,rt+4,t,t,t,r,t,r,t,r,t,t,t,r,r,t,t,r,r,r,r,r,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,r,r,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,r,r,r,r,r,r,r,r,r,r,r,r,r,r,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,r,r,t,t,r,r,t,t,r,r,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,r,r,r,rt+5,e,e,rt+6,rt+7],hs=[[D,D,D,D,D,D,D,D,D,$t,nt,$t,W,nt,D,D,D,D,D,D,D,D,D,D,D,D,D,D,nt,nt,nt,$t,W,t,t,F,F,F,t,t,t,t,t,st,Y,st,Y,Y,k,k,k,k,k,k,k,k,k,k,Y,t,t,t,t,t,t,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,t,t,t,t,t,t,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,t,t,t,t,D,D,D,D,D,D,nt,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,Y,t,F,F,F,F,t,t,t,t,r,t,t,D,t,t,F,F,k,k,t,r,t,t,t,k,r,t,t,t,t,t,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,t,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,t,r,r,r,r,r,r,r,r],[r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,t,t,t,t,t,t,t,t,t,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,t,t,r,r,r,r,r,r,r,t,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,t,r,t,t,t,t,t,t,t,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,A,g,A,g,g,A,g,g,A,g,t,t,t,t,t,t,t,t,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,t,t,t,t,t,A,A,A,A,A,t,t,t,t,t,t,t,t,t,t,t],[z,z,z,z,t,t,t,t,e,F,F,e,Y,e,t,t,g,g,g,g,g,g,g,g,g,g,g,e,t,t,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,z,z,z,z,z,z,z,z,z,z,F,z,z,e,e,e,g,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,g,g,g,g,g,g,g,z,t,g,g,g,g,g,g,e,e,g,g,t,g,g,g,g,e,e,k,k,k,k,k,k,k,k,k,k,e,e,e,e,e,e],[e,e,e,e,e,e,e,e,e,e,e,e,e,e,t,e,e,g,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,t,t,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,g,g,g,g,g,g,g,g,g,g,g,e,t,t,t,t,t,t,t,t,t,t,t,t,t,t,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,A,g,g,g,g,g,g,g,g,g,A,A,t,t,t,t,A,t,t,t,t,t],[W,W,W,W,W,W,W,W,W,W,W,D,D,D,r,A,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,W,nt,is,rs,ns,as,os,Y,F,F,F,F,F,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,Y,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,W,D,D,D,D,D,t,t,t,t,t,D,D,D,D,D,D,k,r,t,t,k,k,k,k,k,k,st,st,t,t,t,r,k,k,k,k,k,k,k,k,k,k,st,st,t,t,t,t,r,r,r,r,r,r,r,r,r,r,r,r,r,t,t,t,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,F,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t],[r,r,r,r,r,r,r,t,t,t,t,t,t,t,t,t,t,t,t,r,r,r,r,r,t,t,t,t,t,A,g,A,A,A,A,A,A,A,A,A,A,st,A,A,A,A,A,A,A,A,A,A,A,A,A,t,A,A,A,A,A,t,A,t,A,A,t,A,A,t,A,A,A,A,A,A,A,A,A,A,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e],[g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,g,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,g,g,g,g,g,g,g,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,Y,t,Y,t,t,Y,t,t,t,t,t,t,t,t,t,F,t,t,st,st,t,t,t,t,t,F,F,t,t,t,t,t,e,e,e,e,e,t,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,t,t,D],[t,t,t,F,F,F,t,t,t,t,t,st,Y,st,Y,Y,k,k,k,k,k,k,k,k,k,k,Y,t,t,t,t,t,t,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,t,t,t,t,t,t,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,t,t,t,t,t,t,t,t,t,t,t,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,t,t,t,r,r,r,r,r,r,t,t,r,r,r,r,r,r,t,t,r,r,r,r,r,r,t,t,r,r,r,t,t,t,F,F,t,t,t,F,F,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t]];class us{constructor(){this.inputFormat="ILYNN",this.outputFormat="VLNNN",this.sourceToTarget=[],this.targetToSource=[],this.levels=[]}bidiTransform(s,i,a){if(this.sourceToTarget=[],this.targetToSource=[],!s)return"";if(Ps(this.sourceToTarget,this.targetToSource,s.length),!this.checkParameters(i,a))return s;i=this.inputFormat,a=this.outputFormat;let n=s;const o=Vs,h=ye(i.charAt(1)),c=ye(a.charAt(1)),u=(i.charAt(0)==="I"?"L":i.charAt(0))+h,f=(a.charAt(0)==="I"?"L":a.charAt(0))+c,d=i.charAt(2)+a.charAt(2);o.defInFormat=u,o.defOutFormat=f,o.defSwap=d;const p=Mt(s,u,f,d,o);let y=!1;return a.charAt(1)==="R"?y=!0:a.charAt(1)!=="C"&&a.charAt(1)!=="D"||(y=this.checkContextual(p)==="rtl"),this.sourceToTarget=X,this.targetToSource=Ds(this.sourceToTarget),Ht=this.targetToSource,n=i.charAt(3)===a.charAt(3)?p:a.charAt(3)==="S"?ds(y,p):ys(p,y,!0),this.sourceToTarget=X,this.targetToSource=Ht,this.levels=jt,n}_inputFormatSetter(s){if(!pe.test(s))throw new Error("dojox/string/BidiEngine: the bidi layout string is wrong!");this.inputFormat=s}_outputFormatSetter(s){if(!pe.test(s))throw new Error("dojox/string/BidiEngine: the bidi layout string is wrong!");this.outputFormat=s}checkParameters(s,i){return s?this._inputFormatSetter(s):s=this.inputFormat,i?this._outputFormatSetter(i):i=this.outputFormat,s!==i}checkContextual(s){let i=Gt(s);if(i!=="ltr"&&i!=="rtl"){try{i=document.dir.toLowerCase()}catch{}i!=="ltr"&&i!=="rtl"&&(i="ltr")}return i}hasBidiChar(s){return Rs.test(s)}}function Mt(l,s,i,a,n){const o=fs(l,{inFormat:s,outFormat:i,swap:a},n);if(o.inFormat===o.outFormat)return l;s=o.inFormat,i=o.outFormat,a=o.swap;const h=s.slice(0,1),c=s.slice(1,4),u=i.slice(0,1),f=i.slice(1,4);if(n.inFormat=s,n.outFormat=i,n.swap=a,h==="L"&&i==="VLTR"){if(c==="LTR")return n.dir=pt,ut(l,n);if(c==="RTL")return n.dir=Pt,ut(l,n)}if(h==="V"&&u==="V")return n.dir=c==="RTL"?Pt:pt,Qt(l,n);if(h==="L"&&i==="VRTL")return c==="LTR"?(n.dir=pt,l=ut(l,n)):(n.dir=Pt,l=ut(l,n)),Qt(l);if(s==="VLTR"&&i==="LLTR")return n.dir=pt,ut(l,n);if(h==="V"&&u==="L"&&c!==f)return l=Qt(l),c==="RTL"?Mt(l,"LLTR","VLTR",a,n):Mt(l,"LRTL","VRTL",a,n);if(s==="VRTL"&&i==="LRTL")return Mt(l,"LRTL","VRTL",a,n);if(h==="L"&&u==="L"){const d=n.swap;return n.swap=d.slice(0,1)+"N",c==="RTL"?(n.dir=Pt,l=ut(l,n),n.swap="N"+d.slice(1,3),n.dir=pt,l=ut(l,n)):(n.dir=pt,l=ut(l,n),n.swap="N"+d.slice(1,3),l=Mt(l,"VLTR","LRTL",n.swap,n)),l}return l}function fs(l,s,i){if(s.inFormat===void 0&&(s.inFormat=i.defInFormat),s.outFormat===void 0&&(s.outFormat=i.defOutFormat),s.swap===void 0&&(s.swap=i.defSwap),s.inFormat===s.outFormat)return s;const a=s.inFormat.slice(0,1),n=s.outFormat.slice(0,1);let o,h=s.inFormat.slice(1,4),c=s.outFormat.slice(1,4);return h.charAt(0)==="C"&&(o=Gt(l),h=o==="ltr"||o==="rtl"?o.toUpperCase():s.inFormat.charAt(2)==="L"?"LTR":"RTL",s.inFormat=a+h),c.charAt(0)==="C"&&(o=Gt(l),o==="rtl"?c="RTL":o==="ltr"?(o=xs(l),c=o.toUpperCase()):c=s.outFormat.charAt(2)==="L"?"LTR":"RTL",s.outFormat=n+c),s}function ds(l,s,i){if(s.length===0)return"";l===void 0&&(l=!0);const a=(s=String(s)).split("");let n=0,o=1,h=a.length;l||(n=a.length-1,o=-1,h=1);const c=gs(a,n,o,h);let u="";for(let f=0;f<a.length;f++)Is(c,c.length,f)>-1?(De(Ht,f,!l,-1),X.splice(f,1)):u+=a[f];return u}function gs(l,s,i,a,n){let o=0;const h=[];let c=0;for(let u=s;u*i<a;u+=i)if(Pe(l[u])||Vt(l[u])){if(l[u]==="ل"&&Ts(l,u+i,i,a)){l[u]=Ms(l[u+i],o===0?We:qe),u+=i,Bs(l,u,i,a),h[c]=u,c++,o=0;continue}const f=l[u];o===1?l[u]=ge(l,u+i,i,a)?ws(l[u]):Xt(l[u],Ze):ge(l,u+i,i,a)===!0?l[u]=Xt(l[u],Qe):l[u]=Xt(l[u],Ye),Vt(f)||(o=1),bs(f)===!0&&(o=0)}else o=0;return h}function Gt(l){const s=/[A-Za-z\u05d0-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(l);return s?s[0]<="z"?"ltr":"rtl":""}function xs(l){const s=l.split("");return s.reverse(),Gt(s.join(""))}function ys(l,s,i){if(l.length===0)return"";s===void 0&&(s=!0);let a="";const n=(l=String(l)).split("");for(let o=0;o<l.length;o++){let h=!1;if(n[o]>="ﹰ"&&n[o]<"\uFEFF"){const c=l.charCodeAt(o);n[o]>="ﻵ"&&n[o]<="ﻼ"?(s?(o>0&&i&&n[o-1]===" "?a=a.slice(0,-1)+"ل":(a+="ل",h=!0),a+=At[(c-65269)/2]):(a+=At[(c-65269)/2],a+="ل",o+1<l.length&&i&&n[o+1]===" "?o++:h=!0),h&&(De(Ht,o,!0,1),X.splice(o,0,X[o]))):a+=Xe[c-65136]}else a+=n[o]}return a}function ut(l,s){const i=l.split(""),a=[];return Me(i,a,s),_s(i,a,s),xe(2,i,a,s),xe(1,i,a,s),jt=a,i.join("")}function Me(l,s,i){const a=l.length,n=i.dir?ss:es;let o=0,h=-1;const c=[],u=[];i.hiLevel=i.dir,i.lastArabic=!1,i.hasUbatAl=!1,i.hasUbatB=!1,i.hasUbatS=!1;for(let f=0;f<a;f++)c[f]=ms(l[f]);for(let f=0;f<a;f++){const d=o,p=As(l,c,u,f,i);u[f]=p,o=n[d][p];const y=240&o;o&=15;const x=n[o][Ss];if(s[f]=x,y>0)if(y===16){for(let _=h;_<f;_++)s[_]=1;h=-1}else h=-1;if(n[o][ks])h===-1&&(h=f);else if(h>-1){for(let _=h;_<f;_++)s[_]=x;h=-1}c[f]===nt&&(s[f]=0),i.hiLevel|=x}i.hasUbatS&&ps(c,s,a,i)}function ps(l,s,i,a){for(let n=0;n<i;n++)if(l[n]===$t){s[n]=a.dir;for(let o=n-1;o>=0&&l[o]===W;o--)s[o]=a.dir}}function _s(l,s,i){if(i.hiLevel!==0&&i.swap[0]!==i.swap[1])for(let a=0;a<l.length;a++)s[a]===1&&(l[a]=Ls(l[a]))}function ms(l){const s=l.charCodeAt(0),i=cs[s>>8];return i<rt?i:hs[i-rt][255&s]}function Qt(l,s){const i=l.split("");if(s){const a=[];Me(i,a,s),jt=a}return i.reverse(),X.reverse(),i.join("")}function Is(l,s,i){for(let a=0;a<s;a++)if(l[a]===i)return a;return-1}function Pe(l){for(let s=0;s<de.length;s++)if(l>=de[s]&&l<=ts[s])return!0;return!1}function ge(l,s,i,a){for(;s*i<a&&Vt(l[s]);)s+=i;return!!(s*i<a&&Pe(l[s]))}function Ts(l,s,i,a){for(;s*i<a&&Vt(l[s]);)s+=i;let n=" ";if(!(s*i<a))return!1;n=l[s];for(let o=0;o<At.length;o++)if(At[o]===n)return!0;return!1}function xe(l,s,i,a){if(a.hiLevel<l)return;if(l===1&&a.dir===Pt&&!a.hasUbatB)return s.reverse(),void X.reverse();const n=s.length;let o,h,c,u,f,d=0;for(;d<n;){if(i[d]>=l){for(o=d+1;o<n&&i[o]>=l;)o++;for(h=d,c=o-1;h<c;h++,c--)u=s[h],s[h]=s[c],s[c]=u,f=X[h],X[h]=X[c],X[c]=f;d=o}d++}}function As(l,s,i,a,n){const o=s[a];return{UBAT_L:()=>(n.lastArabic=!1,r),UBAT_R:()=>(n.lastArabic=!1,A),UBAT_ON:()=>t,UBAT_AN:()=>z,UBAT_EN:()=>n.lastArabic?z:k,UBAT_AL:()=>(n.lastArabic=!0,n.hasUbatAl=!0,A),UBAT_WS:()=>t,UBAT_CS:()=>{let h,c;return a<1||a+1>=s.length||(h=i[a-1])!==k&&h!==z||(c=s[a+1])!==k&&c!==z?t:(n.lastArabic&&(c=z),c===h?c:t)},UBAT_ES:()=>(a>0?i[a-1]:nt)===k&&a+1<s.length&&s[a+1]===k?k:t,UBAT_ET:()=>{if(a>0&&i[a-1]===k)return k;if(n.lastArabic)return t;let h=a+1;const c=s.length;for(;h<c&&s[h]===F;)h++;return h<c&&s[h]===k?k:t},UBAT_NSM:()=>{if(n.inFormat==="VLTR"){const h=s.length;let c=a+1;for(;c<h&&s[c]===g;)c++;if(c<h){const u=l[a].charCodeAt(0),f=u>=1425&&u<=2303||u===64286,d=s[c];if(f&&(d===A||d===e))return A}}return a<1||s[a-1]===nt?t:i[a-1]},UBAT_B:()=>(n.lastArabic=!0,n.hasUbatB=!0,n.dir),UBAT_S:()=>(n.hasUbatS=!0,t),UBAT_LRE:()=>(n.lastArabic=!1,t),UBAT_RLE:()=>(n.lastArabic=!1,t),UBAT_LRO:()=>(n.lastArabic=!1,t),UBAT_RLO:()=>(n.lastArabic=!1,t),UBAT_PDF:()=>(n.lastArabic=!1,t),UBAT_BN:()=>t}[ls[o]]()}function Ls(l){let s,i=0,a=Et.length-1;for(;i<=a;)if(s=Math.floor((i+a)/2),l<Et[s][0])a=s-1;else{if(!(l>Et[s][0]))return Et[s][1];i=s+1}return l}function bs(l){for(let s=0;s<fe.length;s++)if(fe[s]===l)return!0;return!1}function ws(l){for(let s=0;s<zt.length;s++)if(l===zt[s])return Je[s];return l}function Xt(l,s){for(let i=0;i<zt.length;i++)if(l===zt[i])return s[i];return l}function Vt(l){return l>="ً"&&l<="ٕ"}function ye(l){return l==="L"?"LTR":l==="R"?"RTL":l==="C"?"CLR":l==="D"?"CRL":""}function Bs(l,s,i,a){for(;s*i<a&&Vt(l[s]);)s+=i;return s*i<a&&(l[s]=" ",!0)}function Ms(l,s){for(let i=0;i<At.length;i++)if(l===At[i])return s[i];return l}function Ps(l,s,i){X=[],jt=[];for(let a=0;a<i;a++)l[a]=a,s[a]=a,X[a]=a}function Ds(l){const s=new Array(l.length);for(let i=0;i<l.length;i++)s[l[i]]=i;return s}function De(l,s,i,a){for(let n=0;n<l.length;n++)(l[n]>s||!i&&l[n]===s)&&(l[n]+=a)}let X=[],Ht=[],jt=[];const Vs={dir:0,defInFormat:"LLTR",defoutFormat:"VLTR",defSwap:"YN",inFormat:"LLTR",outFormat:"VLTR",swap:"YN",hiLevel:0,lastArabic:!1,hasUbatAl:!1,hasBlockSep:!1,hasSegSep:!1,defOutFormat:""},Ss=5,ks=6,pt=0,Pt=1,pe=/^[(I|V)][(L|R|C|D)][(Y|N)][(S|N)][N]$/,Rs=/[\u0591-\u06ff\ufb1d-\ufefc]/;function Fs(l){return l===746||l===747||!(l<4352)&&(l>=12704&&l<=12735||l>=12544&&l<=12591||l>=65072&&l<=65103&&!(l>=65097&&l<=65103)||l>=63744&&l<=64255||l>=13056&&l<=13311||l>=11904&&l<=12031||l>=12736&&l<=12783||l>=12288&&l<=12351&&!(l>=12296&&l<=12305||l>=12308&&l<=12319||l===12336)||l>=13312&&l<=19903||l>=19968&&l<=40959||l>=12800&&l<=13055||l>=12592&&l<=12687||l>=43360&&l<=43391||l>=55216&&l<=55295||l>=4352&&l<=4607||l>=44032&&l<=55215||l>=12352&&l<=12447||l>=12272&&l<=12287||l>=12688&&l<=12703||l>=12032&&l<=12255||l>=12784&&l<=12799||l>=12448&&l<=12543&&l!==12540||l>=65280&&l<=65519&&!(l===65288||l===65289||l===65293||l>=65306&&l<=65310||l===65339||l===65341||l===65343||l>=65371&&l<=65503||l===65507||l>=65512&&l<=65519)||l>=65104&&l<=65135&&!(l>=65112&&l<=65118||l>=65123&&l<=65126)||l>=5120&&l<=5759||l>=6320&&l<=6399||l>=65040&&l<=65055||l>=19904&&l<=19967||l>=40960&&l<=42127||l>=42128&&l<=42191)}function vs(l){return!(l<11904)&&(l>=12704&&l<=12735||l>=12544&&l<=12591||l>=65072&&l<=65103||l>=63744&&l<=64255||l>=13056&&l<=13311||l>=11904&&l<=12031||l>=12736&&l<=12783||l>=12288&&l<=12351||l>=13312&&l<=19903||l>=19968&&l<=40959||l>=12800&&l<=13055||l>=65280&&l<=65519||l>=12352&&l<=12447||l>=12272&&l<=12287||l>=12032&&l<=12255||l>=12784&&l<=12799||l>=12448&&l<=12543||l>=65040&&l<=65055||l>=42128&&l<=42191||l>=40960&&l<=42127)}function Cs(l){switch(l){case 10:case 32:case 38:case 40:case 41:case 43:case 45:case 47:case 173:case 183:case 8203:case 8208:case 8211:case 8231:return!0}return!1}function _e(l){switch(l){case 9:case 10:case 11:case 12:case 13:case 32:return!0}return!1}const at=24,Ve=17;let Se=class{constructor(s,i,a,n,o,h,c){this._glyphItems=s,this._maxWidth=i,this._lineHeight=a,this._letterSpacing=n,this._hAnchor=o,this._vAnchor=h,this._justify=c}getShaping(s,i,a){const n=this._letterSpacing,o=this._lineHeight,h=this._justify,c=this._maxWidth,u=[];let f=0,d=0;for(const I of s){const w=I.codePointAt(0);if(w==null)continue;const P=a&&Fs(w);let L;for(const M of this._glyphItems)if(L=M[w],L)break;u.push({codePoint:w,x:f,y:d,vertical:P,glyphMosaicItem:L}),L&&(f+=L.metrics.advance+n)}let p=f;c>0&&(p=f/Math.max(1,Math.ceil(f/c)));const y=s.includes("​"),x=[],_=u.length;for(let I=0;I<_-1;I++){const w=u[I].codePoint,P=vs(w);if(Cs(w)||P){let L=0;if(w===10)L-=1e4;else if(P&&y)L+=150;else{w!==40&&w!==65288||(L+=50);const M=u[I+1].codePoint;M!==41&&M!==65289||(L+=50)}x.push(this._buildBreak(I+1,u[I].x,p,x,L,!1))}}const T=this._optimalBreaks(this._buildBreak(_,f,p,x,0,!0));let B=0;const m=i?-o:o;let b=0;for(let I=0;I<T.length;I++){const w=T[I];let P=b;for(;P<w&&_e(u[P].codePoint);)u[P].glyphMosaicItem=null,++P;let L=w-1;for(;L>P&&_e(u[L].codePoint);)u[L].glyphMosaicItem=null,--L;if(P<=L){const M=u[P].x;for(let S=P;S<=L;S++)u[S].x-=M,u[S].y=d;let R=u[L].x;u[L].glyphMosaicItem&&(R+=u[L].glyphMosaicItem.metrics.advance),B=Math.max(R,B),h&&this._applyJustification(u,P,L)}b=w,d+=m}if(u.length>0){const I=T.length-1,w=(h-this._hAnchor)*B;let P=(-this._vAnchor*(I+1)+.5)*o;i&&I&&(P+=I*o);for(const L of u)L.x+=w,L.y+=P}return u.filter(I=>I.glyphMosaicItem)}static getTextBox(s,i){if(!s.length)return null;let a=1/0,n=1/0,o=0,h=0;for(const c of s){const u=c.glyphMosaicItem.metrics.advance,f=c.x,d=c.y-Ve,p=f+u,y=d+i;a=Math.min(a,f),o=Math.max(o,p),n=Math.min(n,d),h=Math.max(h,y)}return{x:a,y:n,width:o-a,height:h-n}}static getBox(s){if(!s.length)return null;let i=1/0,a=1/0,n=0,o=0;for(const h of s){const{height:c,left:u,top:f,width:d}=h.glyphMosaicItem.metrics,p=h.x,y=h.y-(c-Math.abs(f)),x=p+d+u,_=y+c;i=Math.min(i,p),n=Math.max(n,x),a=Math.min(a,y),o=Math.max(o,_)}return{x:i,y:a,width:n-i,height:o-a}}static addDecoration(s,i){const a=s.length;if(a===0)return;const n=3;let o=s[0].x+s[0].glyphMosaicItem.metrics.left,h=s[0].y;for(let u=1;u<a;u++){const f=s[u];if(f.y!==h){const d=s[u-1].x+s[u-1].glyphMosaicItem.metrics.left+s[u-1].glyphMosaicItem.metrics.width;s.push({codePoint:0,x:o,y:h+i-n,vertical:!1,glyphMosaicItem:{sdf:!0,rect:new he(4,0,4,8),metrics:{width:d-o,height:2+2*n,left:0,top:0,advance:0},page:0,code:0}}),h=f.y,o=f.x+f.glyphMosaicItem.metrics.left}}const c=s[a-1].x+s[a-1].glyphMosaicItem.metrics.left+s[a-1].glyphMosaicItem.metrics.width;s.push({codePoint:0,x:o,y:h+i-n,vertical:!1,glyphMosaicItem:{sdf:!0,rect:new he(4,0,4,8),metrics:{width:c-o,height:2+2*n,left:0,top:0,advance:0},page:0,code:0}})}_breakScore(s,i,a,n){const o=(s-i)*(s-i);return n?s<i?o/2:2*o:o+Math.abs(a)*a}_buildBreak(s,i,a,n,o,h){let c=null,u=this._breakScore(i,a,o,h);for(const f of n){const d=i-f.x,p=this._breakScore(d,a,o,h)+f.score;p<=u&&(c=f,u=p)}return{index:s,x:i,score:u,previousBreak:c}}_optimalBreaks(s){return s?this._optimalBreaks(s.previousBreak).concat(s.index):[]}_applyJustification(s,i,a){const n=s[a],o=n.vertical?at:n.glyphMosaicItem?n.glyphMosaicItem.metrics.advance:0,h=(n.x+o)*this._justify;for(let c=i;c<=a;c++)s[c].x-=h}};const me=!0,Ie=4096,Dt=8,xt=.5,te=2;class Ot{constructor(s,i,a=0,n=-1,o=xt){this.x=s,this.y=i,this.angle=a,this.segment=n,this.minzoom=o}}class Nt{constructor(s,i,a,n,o,h=xt,c=mt){this.anchor=s,this.labelAngle=i,this.glyphAngle=a,this.page=n,this.alternateVerticalGlyph=o,this.minzoom=h,this.maxzoom=c}}let Te=class{constructor(s,i,a,n,o,h,c,u,f,d,p,y){this.tl=s,this.tr=i,this.bl=a,this.br=n,this.mosaicRect=o,this.labelAngle=h,this.minAngle=c,this.maxAngle=u,this.anchor=f,this.minzoom=d,this.maxzoom=p,this.page=y}},Ae=class{constructor(s){this.shapes=s}},Us=class{getIconPlacement(s,i,a){const n=new C(s.x,s.y),o=a.rotationAlignment===It.MAP,h=a.keepUpright;let c=a.rotate*ee;o&&(c+=s.angle);const u=new Ae([]);return a.allowOverlap&&a.ignorePlacement||!me||(u.iconColliders=[]),this._addIconPlacement(u,n,i,a,c),o&&h&&this._addIconPlacement(u,n,i,a,c+Bt),u}_addIconPlacement(s,i,a,n,o){const h=a.rasterizationScale,c=a.width/h,u=a.height/h,f=n.offset;let d=f[0],p=f[1];switch(n.anchor){case O.CENTER:d-=c/2,p-=u/2;break;case O.LEFT:p-=u/2;break;case O.RIGHT:d-=c,p-=u/2;break;case O.TOP:d-=c/2;break;case O.BOTTOM:d-=c/2,p-=u;break;case O.TOP_LEFT:break;case O.BOTTOM_LEFT:p-=u;break;case O.TOP_RIGHT:d-=c;break;case O.BOTTOM_RIGHT:d-=c,p-=u}const y=a.rect,x=2/h,_=d-x,T=p-x,B=_+y.width/h,m=T+y.height/h,b=new C(_,T),I=new C(B,m),w=new C(_,m),P=new C(B,T);if(o!==0){const M=Math.cos(o),R=Math.sin(o);b.rotate(M,R),I.rotate(M,R),w.rotate(M,R),P.rotate(M,R)}const L=new Te(b,P,w,I,y,o,0,256,i,xt,mt,0);if(s.shapes.push(L),(!n.allowOverlap||!n.ignorePlacement)&&me){const M=n.size,R=n.padding,S={xTile:i.x,yTile:i.y,dxPixels:d*M-R,dyPixels:p*M-R,hard:!n.optional,partIndex:0,width:c*M+2*R,height:u*M+2*R,angle:o,minLod:xt,maxLod:mt};s.iconColliders.push(S)}}getTextPlacement(s,i,a,n){const o=new C(s.x,s.y),h=n.rotate*ee,c=n.rotationAlignment===It.MAP,u=n.keepUpright,f=n.padding;let d=xt;const p=c?s.angle:0,y=s.segment>=0&&c,x=n.allowOverlap&&n.ignorePlacement?null:[],_=[],T=4,B=!y;let m=Number.POSITIVE_INFINITY,b=Number.NEGATIVE_INFINITY,I=m,w=b;const P=(y||c)&&u,L=n.size/at;let M=!1;for(const V of i)if(V.vertical){M=!0;break}let R,S=0,v=0;if(!y&&M){const V=Se.getTextBox(i,n.lineHeight*at);switch(n.anchor){case O.LEFT:S=V.height/2,v=-V.width/2;break;case O.RIGHT:S=-V.height/2,v=V.width/2;break;case O.TOP:S=V.height/2,v=V.width/2;break;case O.BOTTOM:S=-V.height/2,v=-V.width/2;break;case O.TOP_LEFT:S=V.height;break;case O.BOTTOM_LEFT:v=-V.width;break;case O.TOP_RIGHT:v=V.width;break;case O.BOTTOM_RIGHT:S=-V.height}}S+=n.offset[0]*at,v+=n.offset[1]*at;for(const V of i){const $=V.glyphMosaicItem;if(!$||$.rect.isEmpty)continue;const E=$.rect,N=$.metrics,K=$.page;if(x&&B){if(R!==void 0&&R!==V.y){let G,q,Z,J;M?(G=-w+S,q=m+v,Z=w-I,J=b-m):(G=m+S,q=I+v,Z=b-m,J=w-I);const tt={xTile:s.x,yTile:s.y,dxPixels:G*L-f,dyPixels:q*L-f,hard:!n.optional,partIndex:1,width:Z*L+2*f,height:J*L+2*f,angle:h,minLod:xt,maxLod:mt};x.push(tt),m=Number.POSITIVE_INFINITY,b=Number.NEGATIVE_INFINITY,I=m,w=b}R=V.y}const ft=[];if(y){const G=.5*$.metrics.width,q=(V.x+N.left-T+G)*L*Dt;if(d=this._placeGlyph(s,d,q,a,s.segment,1,V.vertical,K,ft),u&&(d=this._placeGlyph(s,d,q,a,s.segment,-1,V.vertical,K,ft)),d>=te)break}else ft.push(new Nt(o,p,p,K,!1)),c&&u&&ft.push(new Nt(o,p+Bt,p+Bt,K,!1));const et=V.x+N.left,lt=V.y-Ve-N.top,dt=et+N.width,qt=lt+N.height;let j,it,St,kt,gt,Rt,ie,re;if(!y&&M)if(V.vertical){const G=(et+dt)/2-N.height/2,q=(lt+qt)/2+N.width/2;j=new C(-q-T+S,G-T+v),it=new C(j.x+E.width,j.y+E.height),St=new C(j.x,it.y),kt=new C(it.x,j.y)}else j=new C(-lt+T+S,et-T+v),it=new C(j.x-E.height,j.y+E.width),St=new C(it.x,j.y),kt=new C(j.x,it.y);else j=new C(et-T+S,lt-T+v),it=new C(j.x+E.width,j.y+E.height),St=new C(j.x,it.y),kt=new C(it.x,j.y);for(const G of ft){let q,Z,J,tt;if(G.alternateVerticalGlyph){if(!gt){const ct=(lt+qt)/2+v;gt=new C((et+dt)/2+S-N.height/2-T,ct+N.width/2+T),Rt=new C(gt.x+E.height,gt.y-E.width),ie=new C(Rt.x,gt.y),re=new C(gt.x,Rt.y)}q=gt,Z=ie,J=re,tt=Rt}else q=j,Z=St,J=kt,tt=it;const Ft=lt,Yt=qt,vt=G.glyphAngle+h;if(vt!==0){const ct=Math.cos(vt),Ct=Math.sin(vt);q=q.clone(),Z=Z==null?void 0:Z.clone(),J=J==null?void 0:J.clone(),tt=tt==null?void 0:tt.clone(),q.rotate(ct,Ct),tt==null||tt.rotate(ct,Ct),Z==null||Z.rotate(ct,Ct),J==null||J.rotate(ct,Ct)}let Lt=0,bt=256;if(y&&M?V.vertical?G.alternateVerticalGlyph?(Lt=32,bt=96):(Lt=224,bt=32):(Lt=224,bt=96):(Lt=192,bt=64),_.push(new Te(q,J,Z,tt,E,G.labelAngle,Lt,bt,G.anchor,G.minzoom,G.maxzoom,G.page)),x&&(!P||this._legible(G.labelAngle))){if(B)et<m&&(m=et),Ft<I&&(I=Ft),dt>b&&(b=dt),Yt>w&&(w=Yt);else if(G.minzoom<te){const ct={xTile:s.x,yTile:s.y,dxPixels:(et+S)*L-f,dyPixels:(Ft+S)*L-f,hard:!n.optional,partIndex:1,width:(dt-et)*L+2*f,height:(Yt-Ft)*L+2*f,angle:vt,minLod:G.minzoom,maxLod:G.maxzoom};x.push(ct)}}}}if(d>=te)return null;if(x&&B){let V,$,E,N;M?(V=-w+S,$=m+v,E=w-I,N=b-m):(V=m+S,$=I+v,E=b-m,N=w-I);const K={xTile:s.x,yTile:s.y,dxPixels:V*L-f,dyPixels:$*L-f,hard:!n.optional,partIndex:1,width:E*L+2*f,height:N*L+2*f,angle:h,minLod:xt,maxLod:mt};x.push(K)}const U=new Ae(_);return x&&x.length>0&&(U.textColliders=x),U}_legible(s){const i=Be(s);return i<65||i>=193}_placeGlyph(s,i,a,n,o,h,c,u,f){let d=h;const p=d<0?le(s.angle+Bt,ce):s.angle;let y=0;a<0&&(d*=-1,a*=-1,y=Bt),d>0&&++o;let x=new C(s.x,s.y),_=n[o],T=mt;if(n.length<=o)return T;for(;;){const B=_.x-x.x,m=_.y-x.y,b=Math.sqrt(B*B+m*m),I=Math.max(a/b,i),w=B/b,P=m/b,L=le(Math.atan2(P,w)+y,ce);if(f.push(new Nt(x,p,L,u,!1,I,T)),c&&f.push(new Nt(x,p,L,u,!0,I,T)),I<=i)return I;x=_.clone();do{if(o+=d,n.length<=o||o<0)return I;_=n[o]}while(x.isEqual(_));let M=_.x-x.x,R=_.y-x.y;const S=Math.sqrt(M*M+R*R);M*=b/S,R*=b/S,x.x-=M,x.y-=R,T=I}}};var Tt;(function(l){l[l.moveTo=1]="moveTo",l[l.lineTo=2]="lineTo",l[l.close=7]="close"})(Tt||(Tt={}));let Es=class{constructor(s,i,a=0){this.values={},this._geometry=void 0,this._pbfGeometry=null,this.featureIndex=a;const n=i.keys,o=i.values,h=s.asUnsafe();for(;h.next();)switch(h.tag()){case 1:this.id=h.getUInt64();break;case 2:{const c=h.getMessage().asUnsafe(),u=this.values;for(;!c.empty();){const f=c.getUInt32(),d=c.getUInt32();u[n[f]]=o[d]}c.release();break}case 3:this.type=h.getUInt32();break;case 4:this._pbfGeometry=h.getMessage();break;default:h.skip()}}getGeometry(s){if(this._geometry!==void 0)return this._geometry;if(!this._pbfGeometry)return null;const i=this._pbfGeometry.asUnsafe();let a,n;this._pbfGeometry=null,s?s.reset(this.type):a=[];let o,h=Tt.moveTo,c=0,u=0,f=0;for(;!i.empty();){if(c===0){const d=i.getUInt32();h=7&d,c=d>>3}switch(c--,h){case Tt.moveTo:u+=i.getSInt32(),f+=i.getSInt32(),s?s.moveTo(u,f):a&&(n&&a.push(n),n=[],n.push(new C(u,f)));break;case Tt.lineTo:u+=i.getSInt32(),f+=i.getSInt32(),s?s.lineTo(u,f):n&&n.push(new C(u,f));break;case Tt.close:s?s.close():n&&!n[0].equals(u,f)&&n.push(n[0].clone());break;default:throw i.release(),new Error("Invalid path operation")}}return s?o=s.result():a&&(n&&a.push(n),o=a),i.release(),this._geometry=o,o}},_t=class extends H{constructor(){super(12)}add(s,i,a){const n=this.array;n.push(s),n.push(i),n.push(a)}};class se{constructor(s){this.extent=4096,this.keys=[],this.values=[],this._pbfLayer=s.clone();const i=s.asUnsafe();for(;i.next();)switch(i.tag()){case 1:this.name=i.getString();break;case 3:this.keys.push(i.getString());break;case 4:this.values.push(i.processMessage(se._parseValue));break;case 5:this.extent=i.getUInt32();break;default:i.skip()}}getData(){return this._pbfLayer}static _parseValue(s){for(;s.next();)switch(s.tag()){case 1:return s.getString();case 2:return s.getFloat();case 3:return s.getDouble();case 4:return s.getInt64();case 5:return s.getUInt64();case 6:return s.getSInt64();case 7:return s.getBool();default:s.skip()}return null}}let Os=class extends H{constructor(s){super(s)}add(s,i,a,n,o,h,c,u,f,d,p,y){const x=this.array;let _=H.i1616to32(s,i);x.push(_);const T=31;_=H.i8888to32(Math.round(T*a),Math.round(T*n),Math.round(T*o),Math.round(T*h)),x.push(_),_=H.i8888to32(Math.round(T*c),Math.round(T*u),Math.round(T*f),Math.round(T*d)),x.push(_),_=H.i1616to32(p,0),x.push(_),y&&x.push(...y)}},Ns=class extends H{constructor(s){super(s)}add(s,i,a){const n=this.array;n.push(H.i1616to32(s,i)),a&&n.push(...a)}};class $s extends H{constructor(s){super(s)}add(s,i,a,n,o,h,c){const u=this.array,f=this.index;let d=H.i1616to32(s,i);u.push(d);const p=15;return d=H.i8888to32(Math.round(p*a),Math.round(p*n),o,h),u.push(d),c&&u.push(...c),f}}class Le extends H{constructor(s){super(s)}add(s,i,a,n,o,h,c,u,f,d,p,y){const x=this.array;let _=H.i1616to32(s,i);x.push(_),_=H.i1616to32(Math.round(8*a),Math.round(8*n)),x.push(_),_=H.i8888to32(o/4,h/4,u,f),x.push(_),_=H.i8888to32(0,Be(c),10*d,Math.min(10*p,255)),x.push(_),y&&x.push(...y)}}class zs extends H{constructor(s){super(s)}add(s,i,a,n,o){const h=this.array,c=H.i1616to32(2*s+a,2*i+n);h.push(c),o&&h.push(...o)}}class Wt{constructor(s,i,a){this.layerExtent=4096,this._features=[],this.layer=s,this.zoom=i,this._spriteInfo=a,this._filter=s.getFeatureFilter()}pushFeature(s){this._filter&&!this._filter.filter(s,this.zoom)||this._features.push(s)}hasFeatures(){return this._features.length>0}getResources(s,i,a){}}let Gs=class extends Wt{constructor(s,i,a,n,o){super(s,i,a),this.type=Kt.CIRCLE,this._circleVertexBuffer=n,this._circleIndexBuffer=o}get circleIndexStart(){return this._circleIndexStart}get circleIndexCount(){return this._circleIndexCount}processFeatures(s){const i=this._circleVertexBuffer,a=this._circleIndexBuffer;this._circleIndexStart=3*a.index,this._circleIndexCount=0;const n=this.layer,o=this.zoom;s&&s.setExtent(this.layerExtent);for(const h of this._features){const c=h.getGeometry(s);if(!c)continue;const u=n.circleMaterial.encodeAttributes(h,o,n);for(const f of c)if(f)for(const d of f){const p=i.index;i.add(d.x,d.y,0,0,u),i.add(d.x,d.y,0,1,u),i.add(d.x,d.y,1,0,u),i.add(d.x,d.y,1,1,u),a.add(p,p+1,p+2),a.add(p+1,p+2,p+3),this._circleIndexCount+=6}}}serialize(){let s=6;s+=this.layerUIDs.length,s+=this._circleVertexBuffer.array.length,s+=this._circleIndexBuffer.array.length;const i=new Uint32Array(s),a=new Int32Array(i.buffer);let n=0;i[n++]=this.type,i[n++]=this.layerUIDs.length;for(let o=0;o<this.layerUIDs.length;o++)i[n++]=this.layerUIDs[o];i[n++]=this._circleIndexStart,i[n++]=this._circleIndexCount,i[n++]=this._circleVertexBuffer.array.length;for(let o=0;o<this._circleVertexBuffer.array.length;o++)a[n++]=this._circleVertexBuffer.array[o];i[n++]=this._circleIndexBuffer.array.length;for(let o=0;o<this._circleIndexBuffer.array.length;o++)i[n++]=this._circleIndexBuffer.array[o];return i.buffer}},Hs=class ke extends Wt{constructor(s,i,a,n,o,h,c){super(s,i,a),this.type=Kt.FILL,this._patternMap=new Map,this._fillVertexBuffer=n,this._fillIndexBuffer=o,this._outlineVertexBuffer=h,this._outlineIndexBuffer=c}get fillIndexStart(){return this._fillIndexStart}get fillIndexCount(){return this._fillIndexCount}get outlineIndexStart(){return this._outlineIndexStart}get outlineIndexCount(){return this._outlineIndexCount}getResources(s,i,a){const n=this.layer,o=this.zoom,h=n.getPaintProperty("fill-pattern");if(h)if(h.isDataDriven)for(const c of this._features)i(h.getValue(o,c),!0);else i(h.getValue(o),!0)}processFeatures(s){this._fillIndexStart=3*this._fillIndexBuffer.index,this._fillIndexCount=0,this._outlineIndexStart=3*this._outlineIndexBuffer.index,this._outlineIndexCount=0;const i=this.layer,a=this.zoom,{fillMaterial:n,outlineMaterial:o,hasDataDrivenFill:h,hasDataDrivenOutline:c}=i;s&&s.setExtent(this.layerExtent);const u=i.getPaintProperty("fill-pattern"),f=u==null?void 0:u.isDataDriven;let d=!u&&i.getPaintValue("fill-antialias",a);if(i.outlineUsesFillColor){if(d&&!i.hasDataDrivenOpacity){const x=i.getPaintValue("fill-opacity",a),_=i.getPaintValue("fill-opacity",a+1);x<1&&_<1&&(d=!1)}if(d&&!i.hasDataDrivenColor){const x=i.getPaintValue("fill-color",a),_=i.getPaintValue("fill-color",a+1);x[3]<1&&_[3]<1&&(d=!1)}}const p=this._features,y=s==null?void 0:s.validateTessellation;if(f){const x=[];for(const _ of p){const T=u.getValue(a,_),B=this._spriteInfo[T];if(!(B!=null&&B.rect))continue;const m=n.encodeAttributes(_,a,i,B),b=d&&c?o.encodeAttributes(_,a,i):[],I=_.getGeometry(s);x.push({ddFillAttributes:m,ddOutlineAttributes:b,page:B.page,geometry:I}),x.sort((w,P)=>w.page-P.page);for(const{ddFillAttributes:w,ddOutlineAttributes:P,page:L,geometry:M}of x)this._processFeature(M,d,i.outlineUsesFillColor,w,P,y,L)}}else for(const x of p){const _=h?n.encodeAttributes(x,a,i):null,T=d&&c?o.encodeAttributes(x,a,i):null,B=x.getGeometry(s);this._processFeature(B,d,i.outlineUsesFillColor,_,T,y)}}serialize(){let s=10;s+=this.layerUIDs.length,s+=this._fillVertexBuffer.array.length,s+=this._fillIndexBuffer.array.length,s+=this._outlineVertexBuffer.array.length,s+=this._outlineIndexBuffer.array.length,s+=3*this._patternMap.size+1;const i=new Uint32Array(s),a=new Int32Array(i.buffer);let n=0;i[n++]=this.type,i[n++]=this.layerUIDs.length;for(let c=0;c<this.layerUIDs.length;c++)i[n++]=this.layerUIDs[c];i[n++]=this._fillIndexStart,i[n++]=this._fillIndexCount,i[n++]=this._outlineIndexStart,i[n++]=this._outlineIndexCount;const o=this._patternMap,h=o.size;if(i[n++]=h,h>0)for(const[c,[u,f]]of o)i[n++]=c,i[n++]=u,i[n++]=f;i[n++]=this._fillVertexBuffer.array.length;for(let c=0;c<this._fillVertexBuffer.array.length;c++)a[n++]=this._fillVertexBuffer.array[c];i[n++]=this._fillIndexBuffer.array.length;for(let c=0;c<this._fillIndexBuffer.array.length;c++)i[n++]=this._fillIndexBuffer.array[c];i[n++]=this._outlineVertexBuffer.array.length;for(let c=0;c<this._outlineVertexBuffer.array.length;c++)a[n++]=this._outlineVertexBuffer.array[c];i[n++]=this._outlineIndexBuffer.array.length;for(let c=0;c<this._outlineIndexBuffer.array.length;c++)i[n++]=this._outlineIndexBuffer.array[c];return i.buffer}_processFeature(s,i,a,n,o,h,c){if(!s)return;const u=s.length,f=!o||o.length===0;if(i&&(!a||f))for(let y=0;y<u;y++)this._processOutline(s[y],o);const d=32;let p;for(let y=0;y<u;y++){const x=ke._area(s[y]);x>d?(p!==void 0&&this._processFill(s,p,n,h,c),p=[y]):x<-d&&p!==void 0&&p.push(y)}p!==void 0&&this._processFill(s,p,n,h,c)}_processOutline(s,i){const a=this._outlineVertexBuffer,n=this._outlineIndexBuffer,o=n.index;let h,c,u;const f=new C(0,0),d=new C(0,0),p=new C(0,0);let y=-1,x=-1,_=-1,T=-1,B=-1,m=!1;const b=0;let I=s.length;if(I<2)return;const w=s[b];let P=s[I-1];for(;I&&P.isEqual(w);)--I,P=s[I-1];if(!(I-b<2)){for(let L=b;L<I;++L){L===b?(h=s[I-1],c=s[b],u=s[b+1],f.assignSub(c,h),f.normalize(),f.rightPerpendicular()):(h=c,c=u,u=L!==I-1?s[L+1]:s[b],f.assign(d));const M=this._isClipEdge(h,c);T===-1&&(m=M),d.assignSub(u,c),d.normalize(),d.rightPerpendicular();const R=f.x*d.y-f.y*d.x;p.assignAdd(f,d),p.normalize();const S=-p.x*-f.x+-p.y*-f.y;let v=Math.abs(S!==0?1/S:1);v>8&&(v=8),R>=0?(_=a.add(c.x,c.y,f.x,f.y,0,1,i),T===-1&&(T=_),y>=0&&x>=0&&_>=0&&!M&&n.add(y,x,_),x=a.add(c.x,c.y,v*-p.x,v*-p.y,0,-1,i),B===-1&&(B=x),y>=0&&x>=0&&_>=0&&!M&&n.add(y,x,_),y=x,x=_,_=a.add(c.x,c.y,p.x,p.y,0,1,i),y>=0&&x>=0&&_>=0&&!M&&n.add(y,x,_),x=a.add(c.x,c.y,d.x,d.y,0,1,i),y>=0&&x>=0&&_>=0&&!M&&n.add(y,x,_)):(_=a.add(c.x,c.y,v*p.x,v*p.y,0,1,i),T===-1&&(T=_),y>=0&&x>=0&&_>=0&&!M&&n.add(y,x,_),x=a.add(c.x,c.y,-f.x,-f.y,0,-1,i),B===-1&&(B=x),y>=0&&x>=0&&_>=0&&!M&&n.add(y,x,_),y=x,x=_,_=a.add(c.x,c.y,-p.x,-p.y,0,-1,i),y>=0&&x>=0&&_>=0&&!M&&n.add(y,x,_),y=a.add(c.x,c.y,-d.x,-d.y,0,-1,i),y>=0&&x>=0&&_>=0&&!M&&n.add(y,x,_))}y>=0&&x>=0&&T>=0&&!m&&n.add(y,x,T),y>=0&&T>=0&&B>=0&&!m&&n.add(y,B,T),this._outlineIndexCount+=3*(n.index-o)}}_processFill(s,i,a,n,o){n=!0;let h;i.length>1&&(h=[]);let c=0;for(const p of i)c!==0&&h.push(c),c+=s[p].length;const u=2*c,f=ne.acquire();for(const p of i){const y=s[p],x=y.length;for(let _=0;_<x;++_)f.push(y[_].x,y[_].y)}const d=ue(f,h,2);if(n&&ue.deviation(f,h,2,d)>0){const p=i.map(_=>s[_].length),{buffer:y,vertexCount:x}=He(f,p);if(x>0){const _=this._fillVertexBuffer.index;for(let T=0;T<x;T++)this._fillVertexBuffer.add(y[2*T],y[2*T+1],a);for(let T=0;T<x;T+=3){const B=_+T;this._fillIndexBuffer.add(B,B+1,B+2)}if(o!==void 0){const T=this._patternMap,B=T.get(o);B?B[1]+=x:T.set(o,[this._fillIndexStart+this._fillIndexCount,x])}this._fillIndexCount+=x}}else{const p=d.length;if(p>0){const y=this._fillVertexBuffer.index;let x=0;for(;x<u;)this._fillVertexBuffer.add(f[x++],f[x++],a);let _=0;for(;_<p;)this._fillIndexBuffer.add(y+d[_++],y+d[_++],y+d[_++]);if(o!==void 0){const T=this._patternMap,B=T.get(o);B?B[1]+=p:T.set(o,[this._fillIndexStart+this._fillIndexCount,p])}this._fillIndexCount+=p}}ne.release(f)}_isClipEdge(s,i){return s.x===i.x?s.x<=-64||s.x>=4160:s.y===i.y&&(s.y<=-64||s.y>=4160)}static _area(s){let i=0;const a=s.length-1;for(let n=0;n<a;n++)i+=(s[n].x-s[n+1].x)*(s[n].y+s[n+1].y);return i+=(s[a].x-s[0].x)*(s[a].y+s[0].y),.5*i}};const Ks=65535;class js extends Wt{constructor(s,i,a,n,o){super(s,i,a),this.type=Kt.LINE,this._tessellationOptions={pixelCoordRatio:8,halfWidth:0,offset:0},this._patternMap=new Map,this.tessellationProperties={_lineVertexBuffer:null,_lineIndexBuffer:null,_ddValues:null},this.tessellationProperties._lineVertexBuffer=n,this.tessellationProperties._lineIndexBuffer=o,this._lineTessellator=new Ke(Ws(this.tessellationProperties),qs(this.tessellationProperties),s.canUseThinTessellation)}get lineIndexStart(){return this._lineIndexStart}get lineIndexCount(){return this._lineIndexCount}getResources(s,i,a){const n=this.layer,o=this.zoom,h=n.getPaintProperty("line-pattern"),c=n.getPaintProperty("line-dasharray"),u=n.getLayoutProperty("line-cap");if(!h&&!c)return;const f=(u==null?void 0:u.getValue(o))||0,d=u==null?void 0:u.isDataDriven,p=h==null?void 0:h.isDataDriven,y=c==null?void 0:c.isDataDriven;if(p||y)for(const x of this._features)i(p?h.getValue(o,x):this._getDashArrayKey(x,o,n,c,d,u,f));else if(h)i(h.getValue(o));else if(c){const x=c.getValue(o);i(n.getDashKey(x,f))}}processFeatures(s){this._lineIndexStart=3*this.tessellationProperties._lineIndexBuffer.index,this._lineIndexCount=0;const i=this.layer,a=this.zoom,n=this._features,o=this._tessellationOptions,{hasDataDrivenLine:h,lineMaterial:c}=i;s&&s.setExtent(this.layerExtent);const u=i.getPaintProperty("line-pattern"),f=i.getPaintProperty("line-dasharray"),d=u==null?void 0:u.isDataDriven,p=f==null?void 0:f.isDataDriven;let y;y=i.getLayoutProperty("line-cap");const x=y!=null&&y.isDataDriven?y:null,_=x?null:i.getLayoutValue("line-cap",a),T=_||0,B=!!x;y=i.getLayoutProperty("line-join");const m=y!=null&&y.isDataDriven?y:null,b=m?null:i.getLayoutValue("line-join",a);y=i.getLayoutProperty("line-miter-limit");const I=y!=null&&y.isDataDriven?y:null,w=I?null:i.getLayoutValue("line-miter-limit",a);y=i.getLayoutProperty("line-round-limit");const P=y!=null&&y.isDataDriven?y:null,L=P?null:i.getLayoutValue("line-round-limit",a);y=i.getPaintProperty("line-width");const M=y!=null&&y.isDataDriven?y:null,R=M?null:i.getPaintValue("line-width",a);y=i.getPaintProperty("line-offset");const S=y!=null&&y.isDataDriven?y:null,v=S?null:i.getPaintValue("line-offset",a);if(d||p){const U=[];for(const V of n){const $=d?u.getValue(a,V):this._getDashArrayKey(V,a,i,f,B,x,T),E=this._spriteInfo[$];if(!(E!=null&&E.rect))continue;const N=c.encodeAttributes(V,a,i,E),K=V.getGeometry(s);U.push({ddAttributes:N,page:E.page,cap:x?x.getValue(a,V):_,join:m?m.getValue(a,V):b,miterLimit:I?I.getValue(a,V):w,roundLimit:P?P.getValue(a,V):L,halfWidth:.5*(M?M.getValue(a,V):R),offset:S?S.getValue(a,V):v,geometry:K})}U.sort((V,$)=>V.page-$.page),o.textured=!0;for(const{ddAttributes:V,page:$,cap:E,join:N,miterLimit:K,roundLimit:ft,halfWidth:et,offset:lt,geometry:dt}of U)o.capType=E,o.joinType=N,o.miterLimit=K,o.roundLimit=ft,o.halfWidth=et,o.offset=lt,this._processFeature(dt,V,$)}else{if(u){const U=u.getValue(a),V=this._spriteInfo[U];if(!(V!=null&&V.rect))return}o.textured=!(!u&&!f),o.capType=_,o.joinType=b,o.miterLimit=w,o.roundLimit=L,o.halfWidth=.5*R,o.offset=v;for(const U of n){const V=h?c.encodeAttributes(U,a,i):null;x&&(o.capType=x.getValue(a,U)),m&&(o.joinType=m.getValue(a,U)),I&&(o.miterLimit=I.getValue(a,U)),P&&(o.roundLimit=P.getValue(a,U)),M&&(o.halfWidth=.5*M.getValue(a,U)),S&&(o.offset=S.getValue(a,U));const $=U.getGeometry(s);this._processFeature($,V)}}}serialize(){let s=6;s+=this.layerUIDs.length,s+=this.tessellationProperties._lineVertexBuffer.array.length,s+=this.tessellationProperties._lineIndexBuffer.array.length,s+=3*this._patternMap.size+1;const i=new Uint32Array(s),a=new Int32Array(i.buffer);let n=0;i[n++]=this.type,i[n++]=this.layerUIDs.length;for(let c=0;c<this.layerUIDs.length;c++)i[n++]=this.layerUIDs[c];i[n++]=this._lineIndexStart,i[n++]=this._lineIndexCount;const o=this._patternMap,h=o.size;if(i[n++]=h,h>0)for(const[c,[u,f]]of o)i[n++]=c,i[n++]=u,i[n++]=f;i[n++]=this.tessellationProperties._lineVertexBuffer.array.length;for(let c=0;c<this.tessellationProperties._lineVertexBuffer.array.length;c++)a[n++]=this.tessellationProperties._lineVertexBuffer.array[c];i[n++]=this.tessellationProperties._lineIndexBuffer.array.length;for(let c=0;c<this.tessellationProperties._lineIndexBuffer.array.length;c++)i[n++]=this.tessellationProperties._lineIndexBuffer.array[c];return i.buffer}_processFeature(s,i,a){if(!s)return;const n=s.length;for(let o=0;o<n;o++)this._processGeometry(s[o],i,a)}_processGeometry(s,i,a){if(s.length<2)return;const n=.001;let o,h,c=s[0],u=1;for(;u<s.length;)o=s[u].x-c.x,h=s[u].y-c.y,o*o+h*h<n*n?s.splice(u,1):(c=s[u],++u);if(s.length<2)return;const f=this.tessellationProperties._lineIndexBuffer,d=3*f.index;this._tessellationOptions.initialDistance=0,this._tessellationOptions.wrapDistance=Ks,this.tessellationProperties._ddValues=i,this._lineTessellator.tessellate(s,this._tessellationOptions);const p=3*f.index-d;if(a!==void 0){const y=this._patternMap,x=y.get(a);x?x[1]+=p:y.set(a,[d+this._lineIndexCount,p])}this._lineIndexCount+=p}_getDashArrayKey(s,i,a,n,o,h,c){const u=o?h.getValue(i,s):c,f=n.getValue(i,s);return a.getDashKey(f,u)}}const Ws=l=>(s,i,a,n,o,h,c,u,f,d,p)=>(l._lineVertexBuffer.add(s,i,c,u,a,n,o,h,f,d,p,l._ddValues),l._lineVertexBuffer.index-1),qs=l=>(s,i,a)=>{l._lineIndexBuffer.add(s,i,a)},be=10;function Ys(l,s){return l.iconMosaicItem&&s.iconMosaicItem?l.iconMosaicItem.page===s.iconMosaicItem.page?0:l.iconMosaicItem.page-s.iconMosaicItem.page:l.iconMosaicItem&&!s.iconMosaicItem?1:!l.iconMosaicItem&&s.iconMosaicItem?-1:0}class Q extends Wt{constructor(s,i,a,n,o,h,c,u,f){super(i,a,f.getSpriteItems()),this.type=Kt.SYMBOL,this._markerMap=new Map,this._glyphMap=new Map,this._glyphBufferDataStorage=new Map,this._isIconSDF=!1,this._sourceTileKey=s,this._iconVertexBuffer=n,this._iconIndexBuffer=o,this._textVertexBuffer=h,this._textIndexBuffer=c,this._placementEngine=u,this._workerTileHandler=f}get markerPageMap(){return this._markerMap}get glyphsPageMap(){return this._glyphMap}get symbolInstances(){return this._symbolInstances}getResources(s,i,a){const n=this.layer,o=this.zoom;s&&s.setExtent(this.layerExtent);const h=n.getLayoutProperty("icon-image"),c=n.getLayoutProperty("text-field");let u=n.getLayoutProperty("text-transform"),f=n.getLayoutProperty("text-font");const d=[];let p,y,x,_;h&&!h.isDataDriven&&(p=h.getValue(o)),c&&!c.isDataDriven&&(y=c.getValue(o)),u&&u.isDataDriven||(x=n.getLayoutValue("text-transform",o),u=null),f&&f.isDataDriven||(_=n.getLayoutValue("text-font",o),f=null);for(const T of this._features){const B=T.getGeometry(s);if(!B||B.length===0)continue;let m,b;h&&(m=h.isDataDriven?h.getValue(o,T):this._replaceKeys(p,T.values),m&&i(m));let I=!1;if(c&&(b=c.isDataDriven?c.getValue(o,T):this._replaceKeys(y,T.values),b)){switch(b=b.replaceAll("\\n",`
`),u&&(x=u.getValue(o,T)),x){case oe.LOWERCASE:b=b.toLowerCase();break;case oe.UPPERCASE:b=b.toUpperCase()}if(Q._bidiEngine.hasBidiChar(b)){let L;L=Q._bidiEngine.checkContextual(b)==="rtl"?"IDNNN":"ICNNN",b=Q._bidiEngine.bidiTransform(b,L,"VLYSN"),I=!0}if(b.length>0){f&&(_=f.getValue(o,T));for(const L of _){let M=a[L];M||(M=a[L]=new Set);for(const R of b){const S=R.codePointAt(0);S!=null&&M.add(S)}}}}if(!m&&!b)continue;const w=n.getLayoutValue("symbol-sort-key",o,T),P={feature:T,sprite:m,label:b,rtl:I,geometry:B,hash:(b?ae(b):0)^(m?ae(m):0),priority:w,textFont:_};d.push(P)}this._symbolFeatures=d}processFeatures(s){s&&s.setExtent(this.layerExtent);const i=this.layer,a=this.zoom,n=i.getLayoutValue("symbol-placement",a),o=n!==Zt.POINT,h=i.getLayoutValue("symbol-spacing",a)*Dt,c=i.getLayoutProperty("icon-image"),u=i.getLayoutProperty("text-field"),f=c?new Ce(i,a,o):null,d=u?new Ue(i,a,o):null,p=this._workerTileHandler;let y;c&&(y=p.getSpriteItems()),this._iconIndexStart=3*this._iconIndexBuffer.index,this._textIndexStart=3*this._textIndexBuffer.index,this._iconIndexCount=0,this._textIndexCount=0,this._markerMap.clear(),this._glyphMap.clear();const x=[];let _=1;d!=null&&d.size&&(_=d.size/at);const T=d?d.maxAngle*ee:0,B=d?d.size*Dt:0;for(const m of this._symbolFeatures){let b;f&&y&&m.sprite&&(b=y[m.sprite],b&&b.sdf&&(this._isIconSDF=!0));let I;b&&f.update(a,m.feature);let w=0;const P=m.label;if(P){Re(d),d.update(a,m.feature);const L=o&&d.rotationAlignment===It.MAP?d.keepUpright:d.writingMode&&d.writingMode.includes(Ee.VERTICAL);let M=.5;switch(d.anchor){case O.TOP_LEFT:case O.LEFT:case O.BOTTOM_LEFT:M=0;break;case O.TOP_RIGHT:case O.RIGHT:case O.BOTTOM_RIGHT:M=1}let R=.5;switch(d.anchor){case O.TOP_LEFT:case O.TOP:case O.TOP_RIGHT:R=0;break;case O.BOTTOM_LEFT:case O.BOTTOM:case O.BOTTOM_RIGHT:R=1}let S=.5;switch(d.justify){case Jt.AUTO:S=M;break;case Jt.LEFT:S=0;break;case Jt.RIGHT:S=1}const v=d.letterSpacing*at,U=o?0:d.maxWidth*at,V=d.lineHeight*at,$=m.textFont.map(E=>p.getGlyphItems(E));if(I=new Se($,U,V,v,M,R,S).getShaping(P,m.rtl,L),I&&I.length>0){let E=1e30,N=-1e30;for(const K of I)E=Math.min(E,K.x),N=Math.max(N,K.x);w=(N-E+2*at)*_*Dt}}for(let L of m.geometry){const M=[];if(n===Zt.LINE){if(I!=null&&I.length&&(d!=null&&d.size)){const R=d.size*Dt*(2+Math.min(2,4*Math.abs(d.offset[1])));L=Q._smoothVertices(L,R)}Q._pushAnchors(M,L,h,w)}else n===Zt.LINE_CENTER?Q._pushCenterAnchor(M,L):m.feature.type===Ne.Polygon?Q._pushCentroid(M,L):M.push(new Ot(L[0].x,L[0].y));for(const R of M){if(R.x<0||R.x>Ie||R.y<0||R.y>Ie||o&&w>0&&(d==null?void 0:d.rotationAlignment)===It.MAP&&!Q._honorsTextMaxAngle(L,R,w,T,B))continue;const S={shaping:I,line:L,iconMosaicItem:b,anchor:R,symbolFeature:m,textColliders:[],iconColliders:[],textVertexRanges:[],iconVertexRanges:[]};x.push(S),this._processFeature(S,f,d)}}}x.sort(Ys),this._addPlacedGlyphs(),this._symbolInstances=x}serialize(){let s=14;s+=this.layerUIDs.length,s+=3*this.markerPageMap.size,s+=3*this.glyphsPageMap.size,s+=Q._symbolsSerializationLength(this._symbolInstances),s+=this._iconVertexBuffer.array.length,s+=this._iconIndexBuffer.array.length,s+=this._textVertexBuffer.array.length,s+=this._textIndexBuffer.array.length;const i=new Uint32Array(s),a=new Int32Array(i.buffer),n=new Float32Array(i.buffer),[o,h,c]=this._sourceTileKey.split("/");let u=0;i[u++]=this.type,i[u++]=this.layerUIDs.length;for(let f=0;f<this.layerUIDs.length;f++)i[u++]=this.layerUIDs[f];i[u++]=this._isIconSDF?1:0,i[u++]=parseFloat(o),i[u++]=parseFloat(h),i[u++]=parseFloat(c),i[u++]=this.markerPageMap.size;for(const[f,[d,p]]of this.markerPageMap)i[u++]=f,i[u++]=d,i[u++]=p;i[u++]=this.glyphsPageMap.size;for(const[f,[d,p]]of this.glyphsPageMap)i[u++]=f,i[u++]=d,i[u++]=p;i[u++]=this._iconVertexBuffer.index/4,i[u++]=this._textVertexBuffer.index/4,u=Q.serializeSymbols(i,a,n,u,this._symbolInstances),i[u++]=this._iconVertexBuffer.array.length;for(let f=0;f<this._iconVertexBuffer.array.length;f++)a[u++]=this._iconVertexBuffer.array[f];i[u++]=this._iconIndexBuffer.array.length;for(let f=0;f<this._iconIndexBuffer.array.length;f++)i[u++]=this._iconIndexBuffer.array[f];i[u++]=this._textVertexBuffer.array.length;for(let f=0;f<this._textVertexBuffer.array.length;f++)a[u++]=this._textVertexBuffer.array[f];i[u++]=this._textIndexBuffer.array.length;for(let f=0;f<this._textIndexBuffer.array.length;f++)i[u++]=this._textIndexBuffer.array[f];return i.buffer}static _symbolsSerializationLength(s){let i=0;i+=1;for(const a of s||[]){i+=5,i+=1;for(const n of a.textColliders)i+=be;for(const n of a.iconColliders)i+=be;i+=1,i+=2*a.textVertexRanges.length,i+=1,i+=2*a.iconVertexRanges.length}return i}static serializeSymbols(s,i,a,n,o){o=o||[],i[n++]=o.length;for(const h of o){i[n++]=h.anchor.x,i[n++]=h.anchor.y,i[n++]=h.symbolFeature.hash,i[n++]=h.symbolFeature.priority,i[n++]=h.symbolFeature.feature.featureIndex,i[n++]=h.textColliders.length+h.iconColliders.length;for(const c of h.textColliders)i[n++]=c.xTile,i[n++]=c.yTile,i[n++]=c.dxPixels,i[n++]=c.dyPixels,i[n++]=c.hard?1:0,i[n++]=c.partIndex,a[n++]=c.minLod,a[n++]=c.maxLod,i[n++]=c.width,i[n++]=c.height;for(const c of h.iconColliders)i[n++]=c.xTile,i[n++]=c.yTile,i[n++]=c.dxPixels,i[n++]=c.dyPixels,i[n++]=c.hard?1:0,i[n++]=c.partIndex,a[n++]=c.minLod,a[n++]=c.maxLod,i[n++]=c.width,i[n++]=c.height;i[n++]=h.textVertexRanges.length;for(const[c,u]of h.textVertexRanges)i[n++]=c,i[n++]=u;i[n++]=h.iconVertexRanges.length;for(const[c,u]of h.iconVertexRanges)i[n++]=c,i[n++]=u}return n}_replaceKeys(s,i){return s.replaceAll(/{([^{}]+)}/g,(a,n)=>n in i?i[n]:"")}_processFeature(s,i,a){const{line:n,iconMosaicItem:o,shaping:h,anchor:c}=s,u=this.zoom,f=this.layer,d=!!o;let p=!0;d&&(p=(i==null?void 0:i.optional)||!o);const y=h&&h.length>0,x=!y||(a==null?void 0:a.optional);let _,T;if(d&&(_=this._placementEngine.getIconPlacement(c,o,i)),(_||p)&&(y&&(T=this._placementEngine.getTextPlacement(c,h,n,a)),T||x)){if(_&&T||(x||p?x||T?p||_||(T=null):_=null:(_=null,T=null)),T){const B=f.hasDataDrivenText?f.textMaterial.encodeAttributes(s.symbolFeature.feature,u,f):null;if(this._storePlacedGlyphs(s,T.shapes,u,a.rotationAlignment,B),T.textColliders){s.textColliders=T.textColliders;for(const m of T.textColliders){m.minLod=Math.max(u+ht(m.minLod),0),m.maxLod=Math.min(u+ht(m.maxLod),25);const b=m.angle;if(b){const I=Math.cos(b),w=Math.sin(b),P=m.dxPixels*I-m.dyPixels*w,L=m.dxPixels*w+m.dyPixels*I,M=(m.dxPixels+m.width)*I-m.dyPixels*w,R=(m.dxPixels+m.width)*w+m.dyPixels*I,S=m.dxPixels*I-(m.dyPixels+m.height)*w,v=m.dxPixels*w+(m.dyPixels+m.height)*I,U=(m.dxPixels+m.width)*I-(m.dyPixels+m.height)*w,V=(m.dxPixels+m.width)*w+(m.dyPixels+m.height)*I,$=Math.min(P,M,S,U),E=Math.max(P,M,S,U),N=Math.min(L,R,v,V),K=Math.max(L,R,v,V);m.dxPixels=$,m.dyPixels=N,m.width=E-$,m.height=K-N}}}}if(_){const B=f.hasDataDrivenIcon?f.iconMaterial.encodeAttributes(s.symbolFeature.feature,u,f):null;if(this._addPlacedIcons(s,_.shapes,u,o.page,i.rotationAlignment===It.VIEWPORT,B),_.iconColliders){s.iconColliders=_.iconColliders;for(const m of _.iconColliders){m.minLod=Math.max(u+ht(m.minLod),0),m.maxLod=Math.min(u+ht(m.maxLod),25);const b=m.angle;if(b){const I=Math.cos(b),w=Math.sin(b),P=m.dxPixels*I-m.dyPixels*w,L=m.dxPixels*w+m.dyPixels*I,M=(m.dxPixels+m.width)*I-m.dyPixels*w,R=(m.dxPixels+m.width)*w+m.dyPixels*I,S=m.dxPixels*I-(m.dyPixels+m.height)*w,v=m.dxPixels*w+(m.dyPixels+m.height)*I,U=(m.dxPixels+m.width)*I-(m.dyPixels+m.height)*w,V=(m.dxPixels+m.width)*w+(m.dyPixels+m.height)*I,$=Math.min(P,M,S,U),E=Math.max(P,M,S,U),N=Math.min(L,R,v,V),K=Math.max(L,R,v,V);m.dxPixels=$,m.dyPixels=N,m.width=E-$,m.height=K-N}}}}}}_addPlacedIcons(s,i,a,n,o,h){const c=Math.max(a-1,0),u=this._iconVertexBuffer,f=this._iconIndexBuffer,d=this._markerMap;for(const p of i){const y=o?0:Math.max(a+ht(p.minzoom),c),x=o?25:Math.min(a+ht(p.maxzoom),25);if(x<=y)continue;const _=p.tl,T=p.tr,B=p.bl,m=p.br,b=p.mosaicRect,I=p.labelAngle,w=p.minAngle,P=p.maxAngle,L=p.anchor,M=u.index,R=b.x,S=b.y,v=R+b.width,U=S+b.height,V=u.index;u.add(L.x,L.y,_.x,_.y,R,S,I,w,P,y,x,h),u.add(L.x,L.y,T.x,T.y,v,S,I,w,P,y,x,h),u.add(L.x,L.y,B.x,B.y,R,U,I,w,P,y,x,h),u.add(L.x,L.y,m.x,m.y,v,U,I,w,P,y,x,h),s.iconVertexRanges.length>0&&s.iconVertexRanges[0][0]+s.iconVertexRanges[0][1]===V?s.iconVertexRanges[0][1]+=4:s.iconVertexRanges.push([V,4]),f.add(M,M+1,M+2),f.add(M+1,M+2,M+3),d.has(n)?d.get(n)[1]+=6:d.set(n,[this._iconIndexStart+this._iconIndexCount,6]),this._iconIndexCount+=6}}_addPlacedGlyphs(){const s=this._textVertexBuffer,i=this._textIndexBuffer,a=this._glyphMap;for(const[n,o]of this._glyphBufferDataStorage)for(const h of o){const c=s.index,u=h.symbolInstance,f=h.ddAttributes,d=s.index;s.add(h.glyphAnchor[0],h.glyphAnchor[1],h.tl[0],h.tl[1],h.xmin,h.ymin,h.labelAngle,h.minAngle,h.maxAngle,h.minLod,h.maxLod,f),s.add(h.glyphAnchor[0],h.glyphAnchor[1],h.tr[0],h.tr[1],h.xmax,h.ymin,h.labelAngle,h.minAngle,h.maxAngle,h.minLod,h.maxLod,f),s.add(h.glyphAnchor[0],h.glyphAnchor[1],h.bl[0],h.bl[1],h.xmin,h.ymax,h.labelAngle,h.minAngle,h.maxAngle,h.minLod,h.maxLod,f),s.add(h.glyphAnchor[0],h.glyphAnchor[1],h.br[0],h.br[1],h.xmax,h.ymax,h.labelAngle,h.minAngle,h.maxAngle,h.minLod,h.maxLod,f),u.textVertexRanges.length>0&&u.textVertexRanges[0][0]+u.textVertexRanges[0][1]===d?u.textVertexRanges[0][1]+=4:u.textVertexRanges.push([d,4]),i.add(c,c+1,c+2),i.add(c+1,c+2,c+3),a.has(n)?a.get(n)[1]+=6:a.set(n,[this._textIndexStart+this._textIndexCount,6]),this._textIndexCount+=6}this._glyphBufferDataStorage.clear()}_storePlacedGlyphs(s,i,a,n,o){const h=Math.max(a-1,0),c=n===It.VIEWPORT;let u,f,d,p,y,x,_,T,B,m,b;for(const I of i)u=c?0:Math.max(a+ht(I.minzoom),h),f=c?25:Math.min(a+ht(I.maxzoom),25),!(f<=u)&&(d=I.tl,p=I.tr,y=I.bl,x=I.br,_=I.labelAngle,T=I.minAngle,B=I.maxAngle,m=I.anchor,b=I.mosaicRect,this._glyphBufferDataStorage.has(I.page)||this._glyphBufferDataStorage.set(I.page,[]),this._glyphBufferDataStorage.get(I.page).push({glyphAnchor:[m.x,m.y],tl:[d.x,d.y],tr:[p.x,p.y],bl:[y.x,y.y],br:[x.x,x.y],xmin:b.x,ymin:b.y,xmax:b.x+b.width,ymax:b.y+b.height,labelAngle:_,minAngle:T,maxAngle:B,minLod:u,maxLod:f,placementLod:h,symbolInstance:s,ddAttributes:o}))}static _pushAnchors(s,i,a,n){a+=n;let o=0;const h=i.length-1;for(let y=0;y<h;y++)o+=C.distance(i[y],i[y+1]);let c=n||a;if(c*=.5,o<=c)return;const u=c/o;let f=0,d=-(a=o/Math.max(Math.round(o/a),1))/2;const p=i.length-1;for(let y=0;y<p;y++){const x=i[y],_=i[y+1],T=_.x-x.x,B=_.y-x.y,m=Math.sqrt(T*T+B*B);let b;for(;d+a<f+m;){d+=a;const I=(d-f)/m,w=Ut(x.x,_.x,I),P=Ut(x.y,_.y,I);b===void 0&&(b=Math.atan2(B,T)),s.push(new Ot(w,P,b,y,u))}f+=m}}static _pushCenterAnchor(s,i){let a=0;const n=i.length-1;for(let u=0;u<n;u++)a+=C.distance(i[u],i[u+1]);const o=a/2;let h=0;const c=i.length-1;for(let u=0;u<c;u++){const f=i[u],d=i[u+1],p=d.x-f.x,y=d.y-f.y,x=Math.sqrt(p*p+y*y);if(o<h+x){const _=(o-h)/x,T=Ut(f.x,d.x,_),B=Ut(f.y,d.y,_),m=Math.atan2(y,p);return void s.push(new Ot(T,B,m,u,0))}h+=x}}static _deviation(s,i,a){const n=(i.x-s.x)*(a.x-i.x)+(i.y-s.y)*(a.y-i.y),o=(i.x-s.x)*(a.y-i.y)-(i.y-s.y)*(a.x-i.x);return Math.atan2(o,n)}static _honorsTextMaxAngle(s,i,a,n,o){let h=0;const c=a/2;let u=new C(i.x,i.y),f=i.segment+1;for(;h>-c;){if(--f,f<0)return!1;h-=C.distance(s[f],u),u=s[f]}h+=C.distance(s[f],s[f+1]);const d=[];let p=0;const y=s.length;for(;h<c;){const x=s[f];let _,T=f;do{if(++T,T===y)return!1;_=s[T]}while(_.isEqual(x));let B,m=T;do{if(++m,m===y)return!1;B=s[m]}while(B.isEqual(_));const b=this._deviation(x,_,B);for(d.push({deviation:b,distToAnchor:h}),p+=b;h-d[0].distToAnchor>o;)p-=d.shift().deviation;if(Math.abs(p)>n)return!1;h+=C.distance(_,B),f=T}return!0}static _smoothVertices(s,i){if(i<=0)return s;let a=s.length;if(a<3)return s;const n=[];let o=0,h=0;n.push(0);for(let T=1;T<a;T++){const B=C.distance(s[T],s[T-1]);B>0&&(o+=B,n.push(o),h++,h!==T&&(s[h]=s[T]))}if(a=h+1,a<3)return s;i=Math.min(i,.2*o);const c=s[0].x,u=s[0].y,f=s[a-1].x,d=s[a-1].y,p=C.sub(s[0],s[1]);p.normalize(),s[0].x+=i*p.x,s[0].y+=i*p.y,p.assignSub(s[a-1],s[a-2]),p.normalize(),s[a-1].x+=i*p.x,s[a-1].y+=i*p.y,n[0]-=i,n[a-1]+=i;const y=[];y.push(new C(c,u));const x=1e-6,_=.5*i;for(let T=1;T<a-1;T++){let B=0,m=0,b=0;for(let I=T-1;I>=0;I--){const w=_+n[I+1]-n[T];if(w<0)break;const P=n[I+1]-n[I],L=n[T]-n[I]<_?1:w/P;if(L<x)break;const M=L*L,R=L*w-.5*M*P,S=L*P/i,v=s[I+1],U=s[I].x-v.x,V=s[I].y-v.y;B+=S/R*(v.x*L*w+.5*M*(w*U-P*v.x)-M*L*P*U/3),m+=S/R*(v.y*L*w+.5*M*(w*V-P*v.y)-M*L*P*V/3),b+=S}for(let I=T+1;I<a;I++){const w=_-n[I-1]+n[T];if(w<0)break;const P=n[I]-n[I-1],L=n[I]-n[T]<_?1:w/P;if(L<x)break;const M=L*L,R=L*w-.5*M*P,S=L*P/i,v=s[I-1],U=s[I].x-v.x,V=s[I].y-v.y;B+=S/R*(v.x*L*w+.5*M*(w*U-P*v.x)-M*L*P*U/3),m+=S/R*(v.y*L*w+.5*M*(w*V-P*v.y)-M*L*P*V/3),b+=S}y.push(new C(B/b,m/b))}return y.push(new C(f,d)),s[0].x=c,s[0].y=u,s[a-1].x=f,s[a-1].y=d,y}static _pushCentroid(s,i){const c=i.length-1;let u=0,f=0,d=0,p=i[0].x,y=i[0].y;p>4096&&(p=4096),p<0&&(p=0),y>4096&&(y=4096),y<0&&(y=0);for(let x=1;x<c;x++){let _=i[x].x,T=i[x].y,B=i[x+1].x,m=i[x+1].y;_>4096&&(_=4096),_<0&&(_=0),T>4096&&(T=4096),T<0&&(T=0),B>4096&&(B=4096),B<0&&(B=0),m>4096&&(m=4096),m<0&&(m=0);const b=(_-p)*(m-y)-(B-p)*(T-y);u+=b*(p+_+B),f+=b*(y+T+m),d+=b}u/=3*d,f/=3*d,isNaN(u)||isNaN(f)||s.push(new Ot(u,f))}}Q._bidiEngine=new us;var ot;(function(l){l[l.INITIALIZED=0]="INITIALIZED",l[l.NO_DATA=1]="NO_DATA",l[l.READY=2]="READY",l[l.MODIFIED=3]="MODIFIED",l[l.INVALID=4]="INVALID"})(ot||(ot={}));class Zs{constructor(s,i,a,n,o,h){var p;if(this._pbfTiles={},this._tileClippers={},this._client=a,this._tile=i,this._sourceDataMaxLOD=n,h){this._styleLayerUIDs=new Set;for(const y of h)this._styleLayerUIDs.add(y)}this._styleRepository=o,this._layers=((p=this._styleRepository)==null?void 0:p.layers)??[];const[c,u,f]=i.tileKey.split("/").map(parseFloat);this._level=c;const d=$e(this._level);for(const y of Object.keys(s)){const x=s[y];if(this._pbfTiles[y]=new Fe(new Uint8Array(x.protobuff),new DataView(x.protobuff)),x.refKey){const[_]=x.refKey.split("/").map(parseFloat),T=c-_;if(T>0){const B=(1<<T)-1,m=u&B,b=f&B;this._tileClippers[y]=new ze(T,m,b,8,d)}}this._tileClippers[y]||(this._tileClippers[y]=new Ge)}}_canParseStyleLayer(s){return!this._styleLayerUIDs||this._styleLayerUIDs.has(s)}async parse(s){const i=je(),a=this._initialize(s),{returnedBuckets:n}=a;this._processLayers(a),this._linkReferences(a),this._filterFeatures(a);const o=[],h=new Set,c=(d,p)=>{h.has(d)||(o.push({name:d,repeat:p}),h.add(d))},u={};for(const d of n)d.getResources(d.tileClipper,c,u);if(this._tile.status===ot.INVALID)return[];const f=this._fetchResources(o,u,s);return Promise.all([...f,i]).then(()=>this._processFeatures(a.returnedBuckets))}_initialize(s){return{signal:s==null?void 0:s.signal,sourceNameToTileData:this._parseTileData(this._pbfTiles),layers:this._layers,zoom:this._level,sourceNameToTileClipper:this._tileClippers,sourceNameToUniqueSourceLayerBuckets:{},sourceNameToUniqueSourceLayers:{},returnedBuckets:[],layerIdToBucket:{},referencerUIDToReferencedId:new Map}}_processLayers(s){const{sourceNameToTileData:i,zoom:a,layers:n,sourceNameToTileClipper:o,sourceNameToUniqueSourceLayerBuckets:h,sourceNameToUniqueSourceLayers:c,returnedBuckets:u,layerIdToBucket:f,referencerUIDToReferencedId:d}=s,p=this._sourceDataMaxLOD;for(let y=n.length-1;y>=0;y--){const x=n[y];if(a<p){if(x.minzoom&&a<Math.floor(x.minzoom)||x.maxzoom&&a>=x.maxzoom)continue}else if(x.maxzoom&&a>=x.maxzoom)continue;if(x.type===yt.BACKGROUND||!this._canParseStyleLayer(x.uid)||!i[x.source]||!o[x.source])continue;const _=i[x.source],T=o[x.source],B=x.sourceLayer,m=_[B];if(m){let b=c[x.source];if(b||(b=c[x.source]=new Set),b.add(x.sourceLayer),x.refLayerId)d.set(x.uid,x.refLayerId);else{const I=this._createBucket(x);if(I){I.layerUIDs=[x.uid],I.layerExtent=m.extent,I.tileClipper=T;let w=h[x.source];w||(w=h[x.source]={});let P=w[B];P||(P=w[B]=[]),P.push(I),u.push(I),f[x.id]=I}}}}}_linkReferences(s){const{layerIdToBucket:i,referencerUIDToReferencedId:a}=s;a.forEach((n,o)=>{i[n]&&i[n].layerUIDs.push(o)})}_filterFeatures(s){const{signal:i,sourceNameToTileData:a,sourceNameToUniqueSourceLayerBuckets:n,sourceNameToUniqueSourceLayers:o}=s,h=10*this._level,c=10*(this._level+1),u=[],f=[];for(const d of Object.keys(o))o[d].forEach(p=>{u.push(p),f.push(d)});for(let d=0;d<u.length;d++){const p=f[d],y=u[d];if(!a[p]||!n[p])continue;const x=a[p][y],_=n[p][y];if(!_||_.length===0)continue;if(ve(i))return;let T=0;const B=x.getData();for(;B.nextTag(2);){const m=B.getMessage(),b=new Es(m,x,T++);m.release();const I=b.values;if(I){const w=I._minzoom;if(w&&w>=c)continue;const P=I._maxzoom;if(P&&P<=h)continue}for(const w of _)w.pushFeature(b)}}}_fetchResources(s,i,a){const n=[],o=this._tile.getWorkerTileHandler();let h,c;s.length>0&&(h=o.fetchSprites(s,this._client,a),n.push(h));for(const u in i){const f=i[u];f.size>0&&(c=o.fetchGlyphs(this._tile.tileKey,u,f,this._client,a),n.push(c))}return n}_processFeatures(s){const i=s.filter(a=>a.hasFeatures()||this._canParseStyleLayer(a.layer.uid));for(const a of i)a.processFeatures(a.tileClipper);return i}_parseTileData(s){const i={};for(const a of Object.keys(s)){const n=s[a],o={};for(;n.next();)switch(n.tag()){case 3:{const h=n.getMessage(),c=new se(h);h.release(),o[c.name]=c;break}default:n.skip()}i[a]=o}return i}_createBucket(s){switch(s.type){case yt.BACKGROUND:return null;case yt.FILL:return this._createFillBucket(s);case yt.LINE:return this._createLineBucket(s);case yt.CIRCLE:return this._createCircleBucket(s);case yt.SYMBOL:return this._createSymbolBucket(s)}}_createFillBucket(s){return new Hs(s,this._level,this._tile.getWorkerTileHandler().getSpriteItems(),new Ns(s.fillMaterial.getStride()),new _t,new $s(s.outlineMaterial.getStride()),new _t)}_createLineBucket(s){return new js(s,this._level,this._tile.getWorkerTileHandler().getSpriteItems(),new Os(s.lineMaterial.getStride()),new _t)}_createCircleBucket(s){return new Gs(s,this._level,this._tile.getWorkerTileHandler().getSpriteItems(),new zs(s.circleMaterial.getStride()),new _t)}_createSymbolBucket(s){const i=this._tile;return new Q(i.tileKey,s,this._level,new Le(s.iconMaterial.getStride()),new _t,new Le(s.textMaterial.getStride()),new _t,i.placementEngine,i.getWorkerTileHandler())}}let Js=class{constructor(s,i,a,n){this.status=ot.INITIALIZED,this.placementEngine=new Us,this.tileKey=s,this.refKeys=i,this._workerTileHandler=a,this._styleRepository=n}release(){this.tileKey="",this.refKeys=null,this.status=ot.INITIALIZED,this._workerTileHandler=null}async parse(s,i){const a=i==null?void 0:i.signal;if(a!=null){const d=()=>{a.removeEventListener("abort",d),this.status=ot.INVALID};a.addEventListener("abort",d)}let n;const o={bucketsWithData:[],emptyBuckets:null};try{n=await this._parse(s,i)}catch(d){if(we(d))throw d;return{result:o,transferList:[]}}this.status=ot.READY;const h=o.bucketsWithData,c=[];for(const d of n)if(d.hasFeatures()){const p=d.serialize();h.push(p)}else c.push(d.layer.uid);const u=[...h];let f=null;return c.length>0&&(f=Uint32Array.from(c),u.push(f.buffer)),o.emptyBuckets=f,{result:o,transferList:u}}setObsolete(){this.status=ot.INVALID}getLayers(){return this._workerTileHandler.getLayers()}getWorkerTileHandler(){return this._workerTileHandler}async _parse(s,i){const a=s.sourceName2DataAndRefKey;return Object.keys(a).length===0?[]:(this.status=ot.MODIFIED,new Zs(a,this,i.client,s.sourceDataMaxLOD,this._styleRepository,s.styleLayerUIDs).parse(i))}};const Qs=25;class yi{constructor(){this._spriteInfo={},this._glyphInfo={},this._sourceDataMaxLOD=Qs}reset(){return this._spriteInfo={},this._glyphInfo={},Promise.resolve()}getLayers(){var s;return((s=this._styleRepository)==null?void 0:s.layers)??[]}async createTileAndParse(s,i){const{key:a}=s,n={};for(const h of Object.keys(s.sourceName2DataAndRefKey)){const c=s.sourceName2DataAndRefKey[h];n[h]=c.refKey}const o=new Js(a,n,this,this._styleRepository);try{return await o.parse({...s,sourceDataMaxLOD:this._sourceDataMaxLOD},i)}catch(h){if(o.setObsolete(),o.release(),!we(h))throw h;return null}}updateStyle(s){if(!s||s.length===0||!this._styleRepository)return;const i=this._styleRepository;for(const a of s){const n=a.type,o=a.data;switch(n){case wt.PAINTER_CHANGED:i.setPaintProperties(o.layer,o.paint);break;case wt.LAYOUT_CHANGED:i.setLayoutProperties(o.layer,o.layout);break;case wt.LAYER_REMOVED:i.deleteStyleLayer(o.layer);break;case wt.LAYER_CHANGED:i.setStyleLayer(o.layer,o.index);break;case wt.SPRITES_CHANGED:this._spriteInfo={}}}}setStyle(s){const{style:i,sourceDataMaxLOD:a}=s;this._styleRepository=new Oe(i),this._sourceDataMaxLOD=a,this._spriteInfo={},this._glyphInfo={}}fetchSprites(s,i,a){const n=[],o=this._spriteInfo;for(const h of s)o[h.name]===void 0&&n.push(h);return n.length===0?Promise.resolve():i.invoke("getSprites",n,{signal:a==null?void 0:a.signal}).then(h=>{for(const c in h){const u=h[c];o[c]=u}})}getSpriteItems(){return this._spriteInfo}fetchGlyphs(s,i,a,n,o){const h=[];let c=this._glyphInfo[i];return c?a.forEach(u=>{c[u]||h.push(u)}):(c=this._glyphInfo[i]=[],a.forEach(u=>h.push(u))),h.length===0?Promise.resolve():n.invoke("getGlyphs",{tileID:s,font:i,codePoints:h},o).then(u=>{for(let f=0;f<u.length;f++)u[f]&&(c[f]=u[f])})}getGlyphItems(s){return this._glyphInfo[s]}}export{yi as default};
