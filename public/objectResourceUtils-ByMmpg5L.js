const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["public/loader-CZmaS25y.js","public/index-D4VD4zNo.js","public/index-C1I2E1eU.css","public/mat4f64-q_b6UJoq.js","public/quat-CNLPSiKs.js","public/mat3f64-B5o_lm6j.js","public/quatf64-aQ5IuZRd.js","public/BufferView-BUUtgQNn.js","public/resourceUtils-C2rndGy0.js","public/basicInterfaces-N86vRvDz.js"])))=>i.map(i=>d[i]);
import{m3 as we,m4 as ve,jB as X,ht as $e,ks as ae,cf as Y,lk as ie,a6 as Re,bF as le,b0 as Ae,du as Z,hu as ue,lX as V,r as Me,m5 as Be,_ as Oe,cj as Pe,ce as z,fh as J,e_ as Se,m6 as ee,ff as Ie,cB as Ee,kg as _e,eE as ce,m7 as Ce,hN as ke,hO as te,hP as Fe}from"./index-D4VD4zNo.js";import{n as Q,e as fe}from"./mat3f64-B5o_lm6j.js";import{e as je}from"./mat4f64-q_b6UJoq.js";import{L as me,p as de,n as q}from"./OutputColorHighlightOID.glsl-BCnxJSgi.js";import{o as pe,T as he,g as Ue,M as Le,O as qe,V as Ne}from"./BufferView-BUUtgQNn.js";import{r as Ve,n as De,d as re,l as se}from"./vec3-BIkME9u1.js";import{o as Ge,d as ne}from"./vec4-BpN_YXPs.js";import{n as We,o as He,a as ze}from"./indexUtils-BiGLfMwg.js";import{n as N}from"./resourceUtils-C2rndGy0.js";import{t as Qe}from"./NestedMap-BVvDppQU.js";import{A as Ke}from"./Indices-15kDk-kP.js";import{t as Xe}from"./requestImageUtils-DUrf25up.js";import{t as k}from"./orientedBoundingBox-Dus_puEc.js";import{e as K,i as A,n as Ye}from"./basicInterfaces-N86vRvDz.js";import{e as _}from"./VertexAttribute-BfkzOMLV.js";import{W as D,n as Ze,o as Je,s as et,t as tt}from"./RealisticTree.glsl-BCN5Tafw.js";import{a as oe}from"./NormalAttribute.glsl-D0_s50Qe.js";function F(r){if(r==null)return null;const e=r.offset!=null?r.offset:we,n=r.rotation!=null?r.rotation:0,s=r.scale!=null?r.scale:ve,u=Q(1,0,0,0,1,0,e[0],e[1],1),i=Q(Math.cos(n),-Math.sin(n),0,Math.sin(n),Math.cos(n),0,0,0,1),o=Q(s[0],0,0,0,s[1],0,0,0,1),a=fe();return X(a,i,o),X(a,u,a),a}class rt{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class st{constructor(e,n,s){this.name=e,this.lodThreshold=n,this.pivotOffset=s,this.stageResources=new rt,this.numberOfVertices=0}}const P=()=>Ae.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");class nt{constructor(e,n,s){this.resource=e,this.textures=n,this.cachedMemory=s}}async function ot(r,e){const n=await at(r,e),s=await ft(n.textureDefinitions??{},e);let u=0;for(const i in s)if(s.hasOwnProperty(i)){const o=s[i];u+=o!=null&&o.image?o.image.width*o.image.height*4:0}return new nt(n,s,u+$e(n))}async function at(r,e){const n=e==null?void 0:e.streamDataRequester;if(n)return it(r,n,e);const s=await ie(Re(r,e));if(s.ok===!0)return s.value.data;le(s.error),xe(s.error)}async function it(r,e,n){const s=await ie(e.request(r,"json",n));if(s.ok===!0)return s.value;le(s.error),xe(s.error.details.url)}function xe(r){throw new Me("",`Request for object resource failed: ${r}`)}function lt(r){const e=r.params,n=e.topology;let s=!0;switch(e.vertexAttributes||(P().warn("Geometry must specify vertex attributes"),s=!1),e.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const i=e.faces;if(i){if(e.vertexAttributes)for(const o in e.vertexAttributes){const a=i[o];a!=null&&a.values?(a.valueType!=null&&a.valueType!=="UInt32"&&(P().warn(`Unsupported indexed geometry indices type '${a.valueType}', only UInt32 is currently supported`),s=!1),a.valuesPerElement!=null&&a.valuesPerElement!==1&&(P().warn(`Unsupported indexed geometry values per element '${a.valuesPerElement}', only 1 is currently supported`),s=!1)):(P().warn(`Indexed geometry does not specify face indices for '${o}' attribute`),s=!1)}}else P().warn("Indexed geometries must specify faces"),s=!1;break}default:P().warn(`Unsupported topology '${n}'`),s=!1}r.params.material||(P().warn("Geometry requires material"),s=!1);const u=r.params.vertexAttributes;for(const i in u)u[i].values||(P().warn("Geometries with externally defined attributes are not yet supported"),s=!1);return s}function ut(r,e){var x,d;const n=new Array,s=new Array,u=new Array,i=new Qe,o=r.resource,a=ae.parse(o.version||"1.0","wosr");dt.validate(a);const f=o.model.name,t=o.model.geometries,l=o.materialDefinitions??{},c=r.textures;let p=0;const h=new Map;for(let b=0;b<t.length;b++){const g=t[b];if(!lt(g))continue;const v=mt(g),w=g.params.vertexAttributes,R=[],T=m=>{if(g.params.topology==="PerAttributeArray")return null;const $=g.params.faces;for(const y in $)if(y===m)return $[y].values;return null},S=w[_.POSITION],j=S.values.length/S.valuesPerElement;for(const m in w){const $=w[m],y=$.values,W=T(m)??Ke(j);R.push([m,new k(y,W,$.valuesPerElement,!0)])}const M=v.texture,B=c&&c[M];if(B&&!h.has(M)){const{image:m,parameters:$}=B,y=new me(m,$);s.push(y),h.set(M,y)}const U=h.get(M),G=U?U.id:void 0,O=v.material;let I=i.get(O,M);if(I==null){const m=l[O.slice(O.lastIndexOf("/")+1)].params;m.transparency===1&&(m.transparency=0);const $=B?ge(B.alphaChannelUsage):void 0,y={ambient:Y(m.diffuse),diffuse:Y(m.diffuse),opacity:1-(m.transparency||0),textureAlphaMode:$,textureAlphaCutoff:.33,textureId:G,doubleSided:!0,cullFace:K.None,colorMixMode:m.externalColorMixMode||"tint",textureAlphaPremultiplied:(B==null?void 0:B.parameters.preMultiplyAlpha)??!1};e!=null&&e.materialParameters&&Object.assign(y,e.materialParameters),I=new D(y,e),i.set(O,M,I)}u.push(I);const L=new de(I,R);p+=((d=(x=R.find((m=>m[0]===_.POSITION)))==null?void 0:x[1])==null?void 0:d.indices.length)??0,n.push(L)}return{engineResources:[{name:f,stageResources:{textures:s,materials:u,geometries:n},pivotOffset:o.model.pivotOffset,numberOfVertices:p,lodThreshold:null}],referenceBoundingBox:ct(n)}}function ct(r){const e=ue();return r.forEach((n=>{const s=n.boundingInfo;s!=null&&(V(e,s.bbMin),V(e,s.bbMax))})),e}async function ft(r,e){const n=new Array;for(const i in r){const o=r[i],a=o.images[0].data;if(!a){P().warn("Externally referenced texture data is not yet supported");continue}const f=o.encoding+";base64,"+a,t="/textureDefinitions/"+i,l=o.channels==="rgba"?o.alphaChannelUsage||"transparency":"none",c={noUnpackFlip:!0,wrap:{s:Z.REPEAT,t:Z.REPEAT},preMultiplyAlpha:ge(l)!==A.Opaque},p=e!=null&&e.disableTextures?Promise.resolve(null):Xe(f,e);n.push(p.then((h=>({refId:t,image:h,parameters:c,alphaChannelUsage:l}))))}const s=await Promise.all(n),u={};for(const i of s)u[i.refId]=i;return u}function ge(r){switch(r){case"mask":return A.Mask;case"maskAndTransparency":return A.MaskBlend;case"none":return A.Opaque;default:return A.Blend}}function mt(r){const e=r.params;return{id:1,material:e.material,texture:e.texture,region:e.texture}}const dt=new ae(1,2,"wosr");async function pt(r,e){var c;const n=ye(Be(r));if(n.fileType==="wosr"){const p=await(e.cache?e.cache.loadWOSR(n.url,e):ot(n.url,e)),{engineResources:h,referenceBoundingBox:x}=ut(p,e);return{lods:h,referenceBoundingBox:x,isEsriSymbolResource:!1,isWosr:!0}}let s;if(e.cache)s=await e.cache.loadGLTF(n.url,e,!!e.usePBR);else{const{loadGLTF:p}=await Oe(()=>import("./loader-CZmaS25y.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]));s=await p(new We(e.streamDataRequester),n.url,e,e.usePBR)}const u=(c=s.model.meta)==null?void 0:c.ESRI_proxyEllipsoid,i=s.meta.isEsriSymbolResource&&u!=null&&s.meta.ESRI_webstyle==="EsriRealisticTreesStyle";i&&!s.customMeta.esriTreeRendering&&(s.customMeta.esriTreeRendering=!0,Tt(s,u));const o=!!e.usePBR,a=s.meta.isEsriSymbolResource?{usePBR:o,isSchematic:!1,treeRendering:i,mrrFactors:et}:{usePBR:o,isSchematic:!1,treeRendering:!1,mrrFactors:tt},f={...e.materialParameters,treeRendering:i},{engineResources:t,referenceBoundingBox:l}=ht(s,a,f,e,n.specifiedLodIndex,i);return{lods:t,referenceBoundingBox:l,isEsriSymbolResource:s.meta.isEsriSymbolResource,isWosr:!1}}function ye(r){const e=r.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return e?{fileType:"gltf",url:e[1],specifiedLodIndex:e[4]!=null?Number(e[4]):null}:r.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:r,specifiedLodIndex:null}:{fileType:"unknown",url:r,specifiedLodIndex:null}}function ht(r,e,n,s,u,i){const o=r.model,a=new Array,f=new Map,t=new Map,l=o.lods.length,c=ue();return o.lods.forEach(((p,h)=>{const x=s.skipHighLods===!0&&(l>1&&h===0||l>3&&h===1)||s.skipHighLods===!1&&u!=null&&h!==u;if(x&&h!==0)return;const d=new st(p.name,p.lodThreshold,[0,0,0]);p.parts.forEach((b=>{const g=x?new D({},s):xt(o,b,d,e,n,f,t,s,i),{geometry:v,vertexCount:w}=gt(b,g??new D({},s)),R=v.boundingInfo;R!=null&&h===0&&(V(c,R.bbMin),V(c,R.bbMax)),g!=null&&(d.stageResources.geometries.push(v),d.numberOfVertices+=w)})),x||a.push(d)})),{engineResources:a,referenceBoundingBox:c}}function xt(r,e,n,s,u,i,o,a,f){var w,R;const t=r.materials.get(e.material);if(t==null)return null;const{normal:l,color:c,texCoord0:p,tangent:h}=e.attributes,x=e.material+(l?"_normal":"")+(c?"_color":"")+(p?"_texCoord0":"")+(h?"_tangent":""),d=e.attributes.texCoord0!=null,b=e.attributes.normal!=null,g=yt(t.alphaMode);if(!i.has(x)){if(d){const m=(y,W=!1,Te=!1)=>{if(y!=null&&!o.has(y)){const H=r.textures.get(y);if(H){const E=H.data,be=W&&!N(E)?a.compressionOptions:void 0;o.set(y,new me(N(E)?E.data:E,{...H.parameters,preMultiplyAlpha:!N(E)&&Te,encoding:N(E)?E.encoding:void 0,compressionOptions:be}))}}},$=g!==A.Opaque&&!f;m(t.colorTexture,$,g!==A.Opaque),m(t.normalTexture),m(t.occlusionTexture,!0),m(t.emissiveTexture),m(t.metallicRoughnessTexture,!0)}const T=1/ce,S=t.color[0]**T,j=t.color[1]**T,M=t.color[2]**T,B=t.emissiveFactor[0]**T,U=t.emissiveFactor[1]**T,G=t.emissiveFactor[2]**T,O=t.colorTexture!=null&&d?o.get(t.colorTexture):null,I=Ze(t),L=((w=t.normalTextureTransform)==null?void 0:w.scale)!=null?(R=t.normalTextureTransform)==null?void 0:R.scale:Ce;i.set(x,new D({...s,customDepthTest:Ye.Lequal,textureAlphaMode:g,textureAlphaCutoff:t.alphaCutoff,diffuse:[S,j,M],ambient:[S,j,M],opacity:t.alphaMode==="OPAQUE"?1:t.opacity,doubleSided:t.doubleSided,doubleSidedType:"winding-order",cullFace:t.doubleSided?K.None:K.Back,hasVertexColors:!!e.attributes.color,hasVertexTangents:!!e.attributes.tangent,normalType:b?oe.Attribute:oe.ScreenDerivative,castShadows:!0,receiveShadows:t.receiveShadows,receiveAmbientOcclusion:t.receiveAmbientOcclusion,textureId:O!=null?O.id:void 0,colorMixMode:t.colorMixMode,normalTextureId:t.normalTexture!=null&&d?o.get(t.normalTexture).id:void 0,textureAlphaPremultiplied:O!=null&&!!O.parameters.preMultiplyAlpha,occlusionTextureId:t.occlusionTexture!=null&&d?o.get(t.occlusionTexture).id:void 0,emissiveTextureId:t.emissiveTexture!=null&&d?o.get(t.emissiveTexture).id:void 0,metallicRoughnessTextureId:t.metallicRoughnessTexture!=null&&d?o.get(t.metallicRoughnessTexture).id:void 0,emissiveBaseColor:[B,U,G],mrrFactors:I?Je:[t.metallicFactor,t.roughnessFactor,s.mrrFactors[2]],isSchematic:I,colorTextureTransformMatrix:F(t.colorTextureTransform),normalTextureTransformMatrix:F(t.normalTextureTransform),scale:[L[0],L[1]],occlusionTextureTransformMatrix:F(t.occlusionTextureTransform),emissiveTextureTransformMatrix:F(t.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:F(t.metallicRoughnessTextureTransform),...u},a))}const v=i.get(x);if(n.stageResources.materials.push(v),d){const T=S=>{S!=null&&n.stageResources.textures.push(o.get(S))};T(t.colorTexture),T(t.normalTexture),T(t.occlusionTexture),T(t.emissiveTexture),T(t.metallicRoughnessTexture)}return v}function gt(r,e){const n=r.attributes.position.count,s=He(r.indices||n,r.primitiveType),u=q(3*n),{typedBuffer:i,typedBufferStride:o}=r.attributes.position;Ve(u,i,r.transform,3,o);const a=[[_.POSITION,new k(u,s,3,!0)]];if(r.attributes.normal!=null){const t=q(3*n),{typedBuffer:l,typedBufferStride:c}=r.attributes.normal;ke(C,r.transform),De(t,l,C,3,c),te(C)&&re(t,t),a.push([_.NORMAL,new k(t,s,3,!0)])}if(r.attributes.tangent!=null){const t=q(4*n),{typedBuffer:l,typedBufferStride:c}=r.attributes.tangent;Fe(C,r.transform),Ge(t,l,C,4,c),te(C)&&re(t,t,4),a.push([_.TANGENT,new k(t,s,4,!0)])}if(r.attributes.texCoord0!=null){const t=q(2*n),{typedBuffer:l,typedBufferStride:c}=r.attributes.texCoord0;ze(t,l,2,c),a.push([_.UV0,new k(t,s,2,!0)])}const f=r.attributes.color;if(f!=null){const t=new Uint8Array(4*n);f.elementCount===4?f instanceof he?ne(t,f,1,255):(f instanceof Ue||f instanceof Le)&&ne(t,f,1/255,255):(t.fill(255),f instanceof pe?se(t,f.typedBuffer,1,255,4,f.typedBufferStride):(r.attributes.color instanceof qe||r.attributes.color instanceof Ne)&&se(t,f.typedBuffer,1/255,255,4,r.attributes.color.typedBufferStride)),a.push([_.COLOR,new k(t,s,4,!0)])}return{geometry:new de(e,a),vertexCount:n}}const C=fe();function yt(r){switch(r){case"BLEND":return A.Blend;case"MASK":return A.Mask;case"OPAQUE":case null:case void 0:return A.Opaque}}function Tt(r,e){for(let n=0;n<r.model.lods.length;++n){const s=r.model.lods[n];for(const u of s.parts){const i=u.attributes.normal;if(i==null)return;const o=u.attributes.position,a=o.count,f=z(),t=z(),l=z(),c=new Float32Array(4*a),p=new Float32Array(3*a),h=Pe(je(),u.transform);let x=0,d=0;for(let b=0;b<a;b++){o.getVec(b,t),i.getVec(b,f),J(t,t,u.transform),Se(l,t,e.center),ee(l,l,e.radius);const g=l[2],v=Ie(l),w=Math.min(.45+.55*v*v,1)**ce;ee(l,l,e.radius),h!==null&&J(l,l,h),Ee(l,l),n+1!==r.model.lods.length&&r.model.lods.length>1&&_e(l,l,f,g>-1?.2:Math.min(-4*g-3.8,1)),p[x]=l[0],p[x+1]=l[1],p[x+2]=l[2],x+=3,c[d]=w,c[d+1]=w,c[d+2]=w,c[d+3]=1,d+=4}u.attributes.normal=new pe(p),u.attributes.color=new he(c)}}}const jt=Object.freeze(Object.defineProperty({__proto__:null,fetch:pt,parseUrl:ye},Symbol.toStringTag,{value:"Module"}));export{pt as Y,jt as o,F as s};
//# sourceMappingURL=objectResourceUtils-ByMmpg5L.js.map
