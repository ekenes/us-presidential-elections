{"version":3,"file":"WFSSourceWorker-DqdgcVHK.js","sources":["../../node_modules/@arcgis/core/layers/graphics/sources/WFSSourceWorker.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.33/esri/copyright.txt for details.\n*/\nimport{createTask as e}from\"../../../core/asyncUtils.js\";import t from\"../../../core/Error.js\";import r from\"../../../core/Logger.js\";import{clamp as a}from\"../../../core/mathUtils.js\";import{throwIfAborted as s,isAbortError as o}from\"../../../core/promiseUtils.js\";import n from\"../../../core/Warning.js\";import{equals as i}from\"../../../geometry/support/spatialReferenceUtils.js\";import{convertFromGeometry as u,convertToGeometry as l}from\"../featureConversionUtils.js\";import{executeQueryForSnapping as c}from\"../data/executeQueryForSnapping.js\";import h from\"../data/FeatureStore.js\";import{checkProjectionSupport as m,project as p}from\"../data/projectionSupport.js\";import{QueryEngine as d}from\"../data/QueryEngine.js\";import{validateGeoJSON as f,createOptimizedFeatures as g}from\"./geojson/geojson.js\";import{mixAttributes as y}from\"./support/sourceUtils.js\";import{getGetFeatureSpatialReference as _,getFeatureCount as x,getFeature as C}from\"../../ogc/wfsUtils.js\";import w from\"../../support/FieldsIndex.js\";import{isNumber as R}from\"../../../support/guards.js\";import{utc as F}from\"../../../time/constants.js\";const S=\"esri.layers.WFSLayer\";class j{constructor(){this._customParameters=null,this._queryEngine=null,this._supportsPagination=!0}destroy(){this._queryEngine?.destroy(),this._queryEngine=null}async load(e,r={}){const{getFeatureUrl:a,getFeatureOutputFormat:o,fields:n,geometryType:i,featureType:u,maxRecordCount:l,maxTotalRecordCount:c,maxPageCount:p,objectIdField:f,customParameters:g}=e,{spatialReference:y,getFeatureSpatialReference:x}=_(a,u,e.spatialReference);try{await m(x,y)}catch{throw new t(\"unsupported-projection\",\"Projection not supported\",{inSpatialReference:x,outSpatialReference:y})}s(r),this._customParameters=g,this._featureType=u,this._fieldsIndex=w.fromLayerJSON({fields:n,dateFieldsTimeReference:n.some((e=>\"esriFieldTypeDate\"===e.type))?{timeZoneIANA:F}:null}),this._geometryType=i,this._getFeatureUrl=a,this._getFeatureOutputFormat=o,this._getFeatureSpatialReference=x,this._maxRecordCount=l,this._maxTotalRecordCount=c,this._maxPageCount=p,this._objectIdField=f,this._spatialReference=y;let C=await this._snapshotFeatures(r);if(C.errors.length>0&&(this._supportsPagination=!1,C=await this._snapshotFeatures(r),C.errors.length>0))throw C.errors[0];const R={type:\"object-id\",fieldName:f};return this._queryEngine=new d({fieldsIndex:this._fieldsIndex,geometryType:i,hasM:!1,hasZ:!1,featureIdInfo:R,spatialReference:y,timeInfo:null,featureStore:new h({geometryType:i,hasM:!1,hasZ:!1})}),this._queryEngine.featureStore.addMany(C.features),{warnings:q(C),extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async applyEdits(){throw new t(\"wfs-source:editing-not-supported\",\"applyEdits() is not supported on WFSLayer\")}async queryFeatures(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}async queryFeatureCount(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}async queryObjectIds(e={},t={}){await this._waitSnapshotComplete();return(await this._queryEngine.executeQueryForIds(e,t.signal)).filter(R)}async queryExtent(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}async querySnapping(e,t={}){return await this._waitSnapshotComplete(),c(this._queryEngine,e,t.signal)}async queryAttributeBins(e,t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeAttributeBinsQuery(e,t.signal)}async refresh(t){return this._customParameters=t.customParameters,this._maxRecordCount=t.maxRecordCount,this._maxTotalRecordCount=t.maxTotalRecordCount,this._maxPageCount=t.maxPageCount,this._snapshotTask?.abort(),this._snapshotTask=e((e=>this._snapshotFeatures({signal:e}))),this._snapshotTask.promise.then((e=>{this._queryEngine.featureStore.clear(),this._queryEngine.featureStore.addMany(e.features);for(const t of q(e))r.getLogger(S).warn(new n(\"wfs-layer:refresh-warning\",t.message,t.details));e.errors?.length&&r.getLogger(S).warn(new n(\"wfs-layer:refresh-error\",\"Refresh completed with errors\",{errors:e.errors}))}),(()=>{this._queryEngine.featureStore.clear()})),await this._waitSnapshotComplete(),{extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _snapshotFeatures(e){const t=e?.signal,r=this._maxTotalRecordCount,n=this._maxPageCount,i=this._supportsPagination&&n>1?await x(this._getFeatureUrl,this._featureType.typeName,{customParameters:this._customParameters,signal:t}):void 0;let u=[];const l=[];if(null==i)try{u=await this._singleQuery(t)}catch(c){o(c)||l.push(c)}else{const e=Math.min(i,r),s=T(this,a(Math.ceil(e/this._maxRecordCount),1,n),t);await Promise.allSettled(Array.from({length:10}).map((()=>E(s,u,l))))}return s(t),{features:u,totalRecordCount:i,maxTotalRecordCount:r,maxPageCount:n,errors:l}}async _singleQuery(e){const t=Number.isFinite(this._maxRecordCount)&&this._maxRecordCount>0?this._maxRecordCount:void 0,r=await C(this._getFeatureUrl,this._featureType.typeName,this._getFeatureSpatialReference,this._getFeatureOutputFormat,{customParameters:this._customParameters,count:t,signal:e});return this._processGeoJSON(r,{signal:e})}async _pageQuery(e,t){const r=e*this._maxRecordCount,a=await C(this._getFeatureUrl,this._featureType.typeName,this._getFeatureSpatialReference,this._getFeatureOutputFormat,{customParameters:this._customParameters,startIndex:r,count:this._maxRecordCount,signal:t});return this._processGeoJSON(a,{startIndex:r,signal:t})}_processGeoJSON(e,t){f(e,this._getFeatureSpatialReference.wkid);const{startIndex:r,signal:a}=t;s(a);const o=g(e,{geometryType:this._geometryType,hasZ:!1,objectIdField:this._objectIdField});if(!i(this._spatialReference,this._getFeatureSpatialReference))for(const s of o)null!=s.geometry&&(s.geometry=u(p(l(s.geometry,this._geometryType,!1,!1),this._getFeatureSpatialReference,this._spatialReference)));let n=r??1;for(const s of o){const e={};y(this._fieldsIndex,e,s.attributes,!0),s.attributes=e,null==e[this._objectIdField]&&(s.objectId=e[this._objectIdField]=n++)}return o}}function*T(e,t,r){for(let a=0;a<t;a++)yield e._pageQuery(a,r)}async function E(e,t,r){let a=e.next();for(;!a.done;){try{const e=await a.value;t.push(...e)}catch(s){o(s)||r.push(s)}a=e.next()}}function q(e){const t=[];return null!=e.totalRecordCount&&(e.features.length<e.totalRecordCount&&t.push({name:\"wfs-layer:maxRecordCount-too-low\",message:`Could only fetch ${e.features.length} of ${e.totalRecordCount} in ${e.maxPageCount} queries. Try increasing the value of WFSLayer.maxRecordCount.`,details:{recordCount:e.features.length,totalRecordCount:e.totalRecordCount}}),e.totalRecordCount>e.maxTotalRecordCount&&t.push({name:\"wfs-layer:large-dataset\",message:`The number of ${e.totalRecordCount} features exceeds the maximum allowed of ${e.maxTotalRecordCount}.`,details:{recordCount:e.features.length,totalRecordCount:e.totalRecordCount,maxTotalRecordCount:e.maxTotalRecordCount}})),t}export{j as default};\n"],"names":["S","j","_a","r","o","n","i","u","l","p","f","g","y","x","_","m","t","s","w","e","F","C","R","d","h","q","c","T","a","E"],"mappings":"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","x_google_ignoreList":[0]}